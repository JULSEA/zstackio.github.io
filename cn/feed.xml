<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>ZStack</title>
    <description>ZStack is open source IaaS software managing resources of compute, storage, networking throughout a datacenter all by APIs.</description>
    <link>http://zstack.org/</link>
    <atom:link href="http://zstack.org/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Tue, 02 Feb 2016 11:07:06 +0800</pubDate>
    <lastBuildDate>Tue, 02 Feb 2016 11:07:06 +0800</lastBuildDate>
    <generator>Jekyll v2.5.3</generator>
    
      <item>
        <title>ZStack v1.0 RC1 发布</title>
        <description>&lt;h2&gt;ZStack 1.0 RC1 版本今天发布&lt;/h2&gt;

&lt;p&gt;ZStack 1.0 RC1 版本今天发布，欢迎大家下载试用。在该版本中，我们加入了以下新功能。&lt;/p&gt;

&lt;h2&gt;1. Flat Network Provider&lt;/h2&gt;

&lt;p&gt;Flat Network Provider是一种新的网络服务提供模式，它提供DHCP和Userdata服务。相对于已有的Virtual Router Provider，Flat Network Provider最大的优势在于不需要启动一个Virtual Router虚拟机就可以为VM提供DHCP服务，这大大简化了部署一个扁平网络的复杂度。此外，由于采用了分布式DHCP系统，Flat Network Provider不存在传统DHCP系统的单点失败情况，因为每个物理机上都会有一个DHCP服务器服务运行在该物理机上的VM。在高并发创建或启动VM的时候，DHCP的负载会被分发到不同物理机上去，大大提供了系统整体的并发性。下图是分布式DHCP系统的一个总体架构图：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/1.0/1.PNG&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h3&gt;1.1 使用Flat Network Provider&lt;/h3&gt;

&lt;p&gt;当你在创建一个L3网络的时候，在最后一步选择网络服务时做如下操作：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/1.0/2.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;选择“Flat Network Service Provider&quot;做为网络服务提供商&lt;/li&gt;
&lt;li&gt;选择DHCP服务&lt;/li&gt;
&lt;li&gt;点击“添加”按钮&lt;/li&gt;
&lt;li&gt;重复步骤2和3添加user data服务&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;bs-callout bs-callout-info&quot;&gt;
&lt;h4&gt;你可以将Flat Network Provider和Virtual Router Provider混合使用&lt;/h4&gt;
尽管Flat Network Provider的主要目的是为扁平网络情况提供DHCP服务器，你也可以讲它跟已有的Virtual Router Provider混合使用。
例如使用Flat Network Provider提供DHCP，用Virtual Router Provider提供DNS/SNAT等其他服务。
&lt;/div&gt;


&lt;h2&gt;2. User Data&lt;/h2&gt;

&lt;p&gt;标准的&lt;a href=&quot;https://cloudinit.readthedocs.org/en/latest/&quot;&gt;Cloud-init&lt;/a&gt;在该版本中得到支持。要使用user data，你需要在VM的操作系统中安装cloud-init包。User data使用了ZStack的系统标签（System Tags）机制实现，其格式为：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    userdata::{the content}
    例如：
    userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;你应该已经注意到了上面的user data中包含了一个非常长的字符串，它其实是cloud-init的YAML配置文件minify后的结果。因为ZStack的CLI工具只能接受单行字符串，在传递cloud-init YAML配置的时候你需要先把它变成一个单行的字符串。你可以使用下面脚本：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    sed &#39;:a;N;$!ba;s/\n/\\n/g&#39; YAML文件路径
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;输出的长字符串会打印到屏幕，你可以复制黏贴。&lt;/p&gt;

&lt;h3&gt;2.1 使用User Data&lt;/h3&gt;

&lt;p&gt;当你在VM的操作系统中安装完cloud-init包后，我们强烈建议你把它保存成一个模板，这样从该模板新建的VM都会有cloud-init的包。使用下面步骤安装cloud-init包：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;yum install cloud-init 或 apt-get install cloud-init&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在/etc/cloud/cloud.cfg文件中添加如下内容：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; datasource_list:
   - CloudStack
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;cloud-init支持AWS，CloudStack，OpenStack多种获取user data的方式，ZStack使用的是CloudStack方式，即用DHCP服务器提供user data。&lt;/p&gt;

&lt;h4&gt;2.1.1 添加User Data&lt;/h4&gt;

&lt;p&gt;你可以在新建VM的时候指定user data：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateVmInstance name=vm imageUuid=d720ff0c60ee48d3a2e6263dd3e12c33 instanceOfferingUuid=76789b62aeb542a5b4b8b8488fbaced2 l3NetworkUuids=37d3c4a1e2f14a1c8316a23531e62988,05266285f96245f096f3b7dce671991d defaultL3NetworkUuid=05266285f96245f096f3b7dce671991d systemTags=&#39;userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;或者对一个已经创建的VM指定user data：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateSystemTag resourceUuid=303bf80af28c4e23b9b8c20d4267356b resourceType=VmInstanceVO tag=&#39;userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;resourceUuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h4&gt;2.1.2 获得user data&lt;/h4&gt;

&lt;p&gt;你可以用&lt;code&gt;QuerySystemTag&lt;/code&gt;获取一个VM的user data，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    QuerySystemTag resourceUuid=303bf80af28c4e23b9b8c20d4267356b tag~=userdata%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;resourceUuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h4&gt;2.1.3 删除user data&lt;/h4&gt;

&lt;p&gt;你可以用&lt;code&gt;DeleteTag&lt;/code&gt;从一个VM上删除user data，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    DeleteTag uuid=user_data_tag_uuid
    例如：
    DeleteTag uuid=7813d03bb85840c489789f8df3a5915b
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取user data一节的方法拿到。&lt;/p&gt;

&lt;h4&gt;2.1.4 更新user data&lt;/h4&gt;

&lt;p&gt;你可以用&lt;code&gt;UpdateSystemTag&lt;/code&gt;更新一个VM上已有的user data，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateSystemTag uuid=762c3047e05f471ea3fce13f808a50be tag=&#39;userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取user data一节的方法拿到。&lt;/p&gt;

&lt;h4&gt;2.2 注入SSH公钥&lt;/h4&gt;

&lt;p&gt;SSH公钥是用户使用user data最常见的用法，为此我们特别提供了一个专门的system tag，格式为：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    sshkey::{content}
    例如：
    sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5x3AoWuiZawxXoBxEcOhhdVAST4kJA/cQ2zGnh3yZ/KBU+VILQHTkbNWAaRw3q0UtfpLfVj/KoPFr43qjGF+ud8B/rD7stsAvbNVdms81aBDAFZyiN7dhlwTK+XvCMhl4RxHUItm7+Y7gzb8jTHPoqlPzAw4r8enqhNf9ABG+kaXIDa0FPhVaMPoLzHWjTe34ONIBlxsY/y1Zle49vPVYS7oAHQTc7ly7bnGXffNJ18uF5M7HPUgsIDum8KICa2LmnXJeB2M9XZtXtJUdR1ZKXeQpRtikAm3G3CwFkDxWnx31dGr0lLa2aZ88LQ2iP8nb2NK58aKb4I9Aq19k44Rl root@yyy
&lt;/code&gt;&lt;/pre&gt;

&lt;h5&gt;2.2.1 注入SSH公钥&lt;/h5&gt;

&lt;p&gt;你可以在创建VM的时候指定公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateVmInstance name=vm imageUuid=d720ff0c60ee48d3a2e6263dd3e12c33 instanceOfferingUuid=76789b62aeb542a5b4b8b8488fbaced2 l3NetworkUuids=37d3c4a1e2f14a1c8316a23531e62988,05266285f96245f096f3b7dce671991d defaultL3NetworkUuid=05266285f96245f096f3b7dce671991d systemTags=&#39;sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5x3AoWuiZawxXoBxEcOhhdVAST4kJA/cQ2zGnh3yZ/KBU+VILQHTkbNWAaRw3q0UtfpLfVj/KoPFr43qjGF+ud8B/rD7stsAvbNVdms81aBDAFZyiN7dhlwTK+XvCMhl4RxHUItm7+Y7gzb8jTHPoqlPzAw4r8enqhNf9ABG+kaXIDa0FPhVaMPoLzHWjTe34ONIBlxsY/y1Zle49vPVYS7oAHQTc7ly7bnGXffNJ18uF5M7HPUgsIDum8KICa2LmnXJeB2M9XZtXtJUdR1ZKXeQpRtikAm3G3CwFkDxWnx31dGr0lLa2aZ88LQ2iP8nb2NK58aKb4I9Aq19k44Rl root@yyy&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;也可以给一个已有的VM指定公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateSystemTag resourceType=VmInstanceVO resourceUuid=606d9a2fa723407c93438789eaf72cea tag=&quot;sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDdlfgEu4SmgAXaEhLtNljm4cqowdFSyOH7NtheqzZROaRNRJOYKCABUZLmsLv1pl3Av+m1vUUILPWNymxdCnhuaxl/vFtvyWrLChKR8s2Cpl24uFpvHaWO6JLd/RnSwj8LCsCreJ3Twq77T9MCwDVl15WNjn3WKuPfFKxmW7gQTDyDK1XX35n7RYSadurdVNmJTAsQWmszmGeBDVO6U7spRtH7nNrNAMVjaOHrPp5NbMRBVCyHfj1UY71bnIdVCa2mY/RtjIkcj4JNBaQ0JPnP1jw4Ig8WVkjn74T7U4chUHmu8jzwhv+++F7EGLSNdb85RKmY5IdHDd+dRuK3Rx67 root@bji-bm-node3&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h5&gt;2.2.2 获得公钥&lt;/h5&gt;

&lt;p&gt;你可以用&lt;code&gt;QuerySystemTag&lt;/code&gt;获得一个VM的公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    QuerySystemTag resourceUuid=303bf80af28c4e23b9b8c20d4267356b tag~=sshkey%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;resourceUuid&lt;/code&gt;是VM的UUID&lt;/p&gt;

&lt;h5&gt;2.2.3 删除公钥&lt;/h5&gt;

&lt;p&gt;你可以用&lt;code&gt;DeleteTag&lt;/code&gt;从VM上删除一个公钥：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    DeleteTag uuid=user_data_tag_uuid
    例如：
    DeleteTag uuid=7813d03bb85840c489789f8df3a5915b
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取公钥一节的方法拿到。&lt;/p&gt;

&lt;h5&gt;2.2.4 更新公钥&lt;/h5&gt;

&lt;p&gt;你可以使用&lt;code&gt;UpdateSystemTag&lt;/code&gt;更新一个VM的公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateSystemTag uuid=762c3047e05f471ea3fce13f808a50be tag=&#39;sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDdlfgEu4SmgAXaEhLtNljm4cqowdFSyOH7Nthe    qzZROaRNRJOYKCABUZLmsLv1pl3Av+m1vUUILPWNymxdCnhuaxl/vFtvyWrLChKR8s2Cpl24uFpvHaWO6JLd/RnSwj8LCsCreJ3Twq77T9MCwDVl15WNjn3WKuPfFKxmW7gQTDyDK1XX35n7RYSadurdVNmJTAsQWmszmGeBDVO6U7spRtH7nNrNA    MVjaOHrPp5NbMRBVCyHfj1UY71bnIdVCa2mY/RtjIkcj4JNBaQ0JPnP1jw4Ig8WVkjn74T7U4chUHmu8jzwhv+++F7EGLSNdb85RKmY5IdHDd+dRuK3Rx67 root@bji-bm-node3&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取公钥一节的方法拿到。&lt;/p&gt;

&lt;div class=&quot;bs-callout bs-callout-warning&quot;&gt;
&lt;h4&gt;你或许需要重启VM让公钥生效&lt;/h4&gt;

如果你是给一个已有的VM创建公钥或者更新公钥，你需要做如下步骤：&lt;br&gt;
1. 删除在VM中删除已有的cloud-init数据，rm -rf /var/lib/cloud&lt;br&gt;
2. 重启VM&lt;br&gt;

对于给新建的VM指定公钥，你无需做这些步骤。
&lt;/div&gt;


&lt;h2&gt;3. 本地存储的磁盘迁移&lt;/h2&gt;

&lt;p&gt;在本版本中，你可以在本地存储的不同物理机间迁移虚拟机的磁盘(volume)，解决使用本地存储虚拟机不能迁移的的问题。&lt;/p&gt;

&lt;h3&gt;3.1 迁移磁盘&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;LocalStorageMigrateVolume&lt;/code&gt;迁移VM的root volume和data volume。例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    LocalStorageMigrateVolume volumeUuid=cdbda88fef1a42f386ff111b729159d9 destHostUuid=252d484d93e64fea946148097162b60f
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;3.2 迁移规则&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;如果迁移的是root volume，需要先关闭虚拟机&lt;/li&gt;
&lt;li&gt;如果迁移的是data volume，需要先将data volume从虚拟机卸载（detach)&lt;/li&gt;
&lt;li&gt;如果volume上有快照（snapshots），快照会被一并迁移&lt;/li&gt;
&lt;/ol&gt;


&lt;h3&gt;3.3 使用磁盘迁移迁移VM&lt;/h3&gt;

&lt;p&gt;你可以使用磁盘迁移功能在不同物理机上冷迁移虚拟机：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;关闭虚拟机&lt;/li&gt;
&lt;li&gt;将虚拟机的root volume迁移到目的物理机&lt;/li&gt;
&lt;li&gt;启动虚拟机&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;&lt;p&gt;ZStack实际是支持本地存储的虚拟机热迁移的。但在我们的压力测试中，我们发现KVM的带存储热迁移不稳定。我们在一个虚拟机中做一次Linux内核编译，并在这个过程中做带存储热迁移，迁移完成后重启虚拟机，发现虚拟机磁盘损坏。为了保护用户数据，我们在API层面关闭了虚拟机带存储热迁移的功能。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h2&gt;4. ISO API&lt;/h2&gt;

&lt;p&gt;在该版本中，你可以使用API向一个VM加载或卸载一个ISO，并且改变VM的启动设备顺序。&lt;/p&gt;

&lt;h3&gt;4.1 添加ISO&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;AttachIsoToVmInstance&lt;/code&gt;向一个VM添加一个ISO，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    AttachIsoToVmInstance vmInstanceUuid=d4a83b0394b44482bbcb964b4dbe991c isoUuid=815dcd3d83dd429298ba2c9b1685c1ad
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;4.2 卸载ISO&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;DetachIsoFromVmInstance&lt;/code&gt;从一个VM上卸载一个ISO，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    DetachIsoFromVmInstance vmInstanceUuid=d4a83b0394b44482bbcb964b4dbe991c
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h3&gt;4.3 设置启动设备顺序&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;SetVmBootOrder&lt;/code&gt;设置VM的启动设备顺序，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    SetVmBootOrder uuid=303bf80af28c4e23b9b8c20d4267356b bootOrder=HardDisk,CdRom
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;合法的启动顺序包括：HardDisk和CdRom&lt;/p&gt;&lt;/blockquote&gt;

&lt;h3&gt;4.4 获得启动设备顺序&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;GetVmBootOrder&lt;/code&gt;获得VM的启动设备顺序，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    GetVmBootOrder uuid=303bf80af28c4e23b9b8c20d4267356b
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h3&gt;4.5 设备启动顺序规则&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;如果使用ISO创建一个VM，则该VM的启动设备自动被设置为CdRom。当操作系统安装完成并重启后，启动顺序自动改成HardDisk&lt;/li&gt;
&lt;li&gt;如果使用template创建一个VM，改VM的启动设备自动被设置为HardDisk&lt;/li&gt;
&lt;li&gt;加载一个ISO到一个VM不改变其启动顺序。如果需要，你可以用&lt;code&gt;SetVmBootOrder&lt;/code&gt;更改&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;5. Spice支持&lt;/h2&gt;

&lt;p&gt;在该版本中，我们支持Spice协议作为VM图形终端协议。你可以通过更改全局选项进行设置，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=kvm name=vm.consoleMode value=spice
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;合法的协议包括：vnc和spice&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;目前ZStack还没有针对spice的console proxy，你需要下载一个spice客户端直接连接VM在物理机上的spice端口。你可以用下面的API来获得物理机的IP和VM的spice端口号：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    &amp;gt;&amp;gt;&amp;gt;GetVmConsoleAddress uuid=9cd68155905e47b5b0698ecba9126242
    {
        &quot;hostIp&quot;: &quot;192.168.199.136&quot;,
        &quot;port&quot;: 5902,
        &quot;protocol&quot;: &quot;spice&quot;,
        &quot;success&quot;: true
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。感谢来至武汉纺织大学的Nan Su(fengcai_ji@163.com)同学贡献了这个功能。&lt;/p&gt;

&lt;h2&gt;6. I18N支持&lt;/h2&gt;

&lt;p&gt;在该版本中，我们支持多语言版本，目前支持英文和中文，你可以通过点击语言图标进行切换。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/1.0/3.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;感谢来自武汉纺织大学的Nan Su(fengcai_ji@163.com), Zhiqiang Hu(1063751150@qq.com)u Qi Wei(804470533@qq.com), Yu Chen(ppak@sohu.com), Wanling Xue(1962670706@qq.com)贡献了该功能。&lt;/p&gt;

&lt;h2&gt;7. VM状态的实时捕获&lt;/h2&gt;

&lt;p&gt;在该版本中，我们支持VM状态的实时捕获。如果用户绕过ZStack对VM进行了操作，其状态会实时的发送回管理节点进行更新。也就是说你可以在VM内部
通过halt命令来关闭虚拟机，而不用通过ZStack UI。虽然不推荐，但如果你用virsh关闭或者启动了一个VM，其在ZStack中的状态也会被实时更新。&lt;/p&gt;

&lt;h2&gt;8. 资源删除策略控制&lt;/h2&gt;

&lt;p&gt;从该版本开始，我们对一些关键资源实现了删除策略控制，用户可以控制资源的删除方式，以防误删除。目前支持删除策略控制的资源包括：虚拟机、磁盘(volume)、镜像（image）。目前支持的删除策略包括：&lt;strong&gt;Direct（直接删除）&lt;/strong&gt;, &lt;strong&gt;Delay（延时删除）&lt;/strong&gt;, &lt;strong&gt;Never（从不删除）&lt;/strong&gt;三种。默认的策略是Delay。&lt;/p&gt;

&lt;h3&gt;8.1 策略规则&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Direct: 资源会直接被物理删除，并在数据库中删除，无法恢复。&lt;/li&gt;
&lt;li&gt;Delay：资源会首先在数据库中被标记成删除，但不会物理删除。在一定的时间内，用户可以使用API对资源进行恢复，在此期间资源仍然物理存在，所以它还会占用物理空间（例如磁盘空间）。在超过一定时间后，资源会被物理删除，无法再恢复。&lt;/li&gt;
&lt;li&gt;Never：资源数据库中标记成删除，永远不会被物理删除，一直占用物理空间。&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;8.2 虚拟机删除策略&lt;/h3&gt;

&lt;p&gt;你可以更改虚拟机的删除策略，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=vm name=deletionPolicy value=Direct
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果删除策略是Delay，你可以指定延时删除的时间，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=vm name=expungePeriod value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;单位为秒。在上面的例子中，虚拟机在被标记成删除后的1个小时后被测地删除。&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;如果删除策略是Delay，ZStack会周期性的去检查资源是否应该被物理删除，你可以控制周期性轮询的时间：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=vm name=expungeInterval value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;单位为秒&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;你也可以恢复一个处于删除状态的虚拟机：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverVmInstance vmInstanceUuid=8c4c4c0bbac7441fb056d0d6e2168996
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;8.3 镜像删除策略&lt;/h3&gt;

&lt;p&gt;跟虚拟机一样，你可以改变相应的设置：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=image name=deletionPolicy value=Direct
    UpdateGlobalConfig category=image name=expungePeriod value=3600
    UpdateGlobalConfig category=image name=expungeInterval value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;也可以恢复一个处于删除状态的镜像：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverImage imageUuid=8c4c4c0bbac7441fb056d0d6e2168996
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果镜像存在于多个备份存储，你只想恢复在某些备份存储上的镜像，可以通过额外参数指定：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverImage imageUuid=8c4c4c0bbac7441fb056d0d6e2168996 backupStorageUuids=36c27e8ff05c4780bf6d2fa65700f22e
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;8.4 磁盘删除策略&lt;/h3&gt;

&lt;p&gt;跟虚拟机一样，你可以通过改变相应的设置：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=volume name=deletionPolicy value=Direct
    UpdateGlobalConfig category=volume name=expungePeriod value=3600
    UpdateGlobalConfig category=volume name=expungeInterval value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;你也可以恢复一个处于删除状态数据磁盘(data volume)：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverDataVolume uuid=36c27e8ff05c4780bf6d2fa65700f22e
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;根磁盘(root volume)的恢复是在恢复虚拟机的时候自动恢复。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h2&gt;9. CPU型号Paasthrough(支持嵌套虚拟化)&lt;/h2&gt;

&lt;p&gt;你可以通过改变全局配置让虚拟机获得跟物理机CPU相同的型号：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=kvm name=vm.cpuMode value=host-model
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;支持三种模式：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;none: CPU型号为QEMU模拟器&lt;/li&gt;
&lt;li&gt;host-model：CPU类型为物理机CPU类型&lt;/li&gt;
&lt;li&gt;host-passthrough：CPU型号跟物理机CPU完全一样&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;当模式为&lt;code&gt;host-model&lt;/code&gt;和&lt;code&gt;host-passthrough&lt;/code&gt;时，虚拟机可以获得嵌套虚拟化功能。&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;使用该功能可能会影响虚拟机热迁移。因为热迁移时会检查虚拟机CPU型号，如果两台物理机的CPU型号不同，会导致虚拟机热迁移失败。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h2&gt;10. 安装&lt;/h2&gt;

&lt;p&gt;你可以通过下面方式安装：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    wget http://7xi3lj.com1.z0.glb.clouddn.com/releases%2F1.0%2F1.0.0%2Fzstack-installer-1.0-rc4.bin -O zstack-installer-1.0-rc4.bin
    bash zstack-installer-1.0-rc4.bin -R aliyun
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;这里&lt;code&gt;-R aliyun&lt;/code&gt;参数指定使用阿里云的源进行安装，你也可以使用&lt;code&gt;-R 163&lt;/code&gt;使用网易的源。我们推荐使用阿里云的源&lt;/p&gt;&lt;/blockquote&gt;

&lt;h2&gt;11. 升级&lt;/h2&gt;

&lt;p&gt;一如既往的，我们支持一键无缝升级：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    wget http://7xi3lj.com1.z0.glb.clouddn.com/releases%2F1.0%2F1.0.0%2Fzstack-installer-1.0-rc4.bin -O zstack-installer-1.0-rc4.bin
    bash zstack-installer-1.0-rc4.bin -u
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;如果你安装了多个管理节点，请等待最终GA版本的升级步骤。这里的升级步骤只适合all-in-one安装的ZStack。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h2&gt;12. 用Flat Network Provider替换Virtual Router Provider&lt;/h2&gt;

&lt;p&gt;如果你的网络模式是扁平网络，并且使用的是Virtual Rotuer Provider作为网络提供商，你可以使用1.0的Flat Network Provider替换它，这样你就不再需要virtual router VM来充当DHCP服务器了。假定你要替换网络提供商的L3网络的UUID是1a82c2691978476fa6cefa36bb9d4bfd，参考以下步骤：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;获得当前L3网络的网络提供商UUID&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryNetworkServiceL3NetworkRef l3NetworkUuid=1a82c2691978476fa6cefa36bb9d4bfd
 {
     &quot;inventories&quot;: [
         {
             &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;networkServiceProviderUuid&quot;: &quot;5d21ea0f39c04d6fb68cfaf5a37db4ad&quot;,
             &quot;networkServiceType&quot;: &quot;DNS&quot;
         },
         {
             &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;networkServiceProviderUuid&quot;: &quot;5d21ea0f39c04d6fb68cfaf5a37db4ad&quot;,
             &quot;networkServiceType&quot;: &quot;DHCP&quot;
         }
     ],
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;从L3网络上卸载Virtual Router Provider&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;DetachNetworkServiceFromL3Network  l3NetworkUuid=1a82c2691978476fa6cefa36bb9d4bfd networkServices=&#39;{&quot;5d21ea0f39c04d6fb68cfaf5a37db4ad&quot;:[&quot;DHCP&quot;,&quot;DNS&quot;]}&#39;
 {
     &quot;inventory&quot;: {
         &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;dns&quot;: [
             &quot;8.8.8.8&quot;
         ],
         &quot;ipRanges&quot;: [
             {
                 &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;endIp&quot;: &quot;192.168.201.199&quot;,
                 &quot;gateway&quot;: &quot;192.168.200.1&quot;,
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;name&quot;: &quot;ipr-dk7p&quot;,
                 &quot;netmask&quot;: &quot;255.255.252.0&quot;,
                 &quot;startIp&quot;: &quot;192.168.201.180&quot;,
                 &quot;uuid&quot;: &quot;ec5fd87dd80243fdabeeace847c04427&quot;
             }
         ],
         &quot;l2NetworkUuid&quot;: &quot;9ec8cad681d1424fa7eda2447edae142&quot;,
         &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;name&quot;: &quot;l3-etpz&quot;,
         &quot;networkServices&quot;: [],
         &quot;state&quot;: &quot;Enabled&quot;,
         &quot;system&quot;: false,
         &quot;type&quot;: &quot;L3BasicNetwork&quot;,
         &quot;uuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
         &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
     },
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;&lt;p&gt;注意这里的参数networkServices是一个map， key是第一步里返回的networkServiceProviderUuid，value是第一步里返回的networkServiceType&lt;/p&gt;&lt;/blockquote&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;获得Flat Network Provider的UUID&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryNetworkServiceProvider type=Flat
 {
     &quot;inventories&quot;: [
         {
             &quot;attachedL2NetworkUuids&quot;: [
                 &quot;9ec8cad681d1424fa7eda2447edae142&quot;
             ],
             &quot;createDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
             &quot;description&quot;: &quot;Flat Network Service Provider&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
             &quot;name&quot;: &quot;Flat Network Service Provider&quot;,
             &quot;networkServiceTypes&quot;: [
                 &quot;DHCP&quot;,
                 &quot;Userdata&quot;
             ],
             &quot;type&quot;: &quot;Flat&quot;,
             &quot;uuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;
         }
     ],
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;获得承载L3网络的L2网络的UUID&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryL3Network fields=l2NetworkUuid, uuid=1a82c2691978476fa6cefa36bb9d4bfd
 {
     &quot;inventories&quot;: [
         {
             &quot;l2NetworkUuid&quot;: &quot;9ec8cad681d1424fa7eda2447edae142&quot;
         }
     ],
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;加载Flat Network Provider到L2网络&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;AttachNetworkServiceProviderToL2Network l2NetworkUuid=9ec8cad681d1424fa7eda2447edae142 networkServiceProviderUuid=17864f985e584a9ba4cd81de215212ce
 {
     &quot;inventory&quot;: {
         &quot;attachedL2NetworkUuids&quot;: [
             &quot;9ec8cad681d1424fa7eda2447edae142&quot;
         ],
         &quot;createDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
         &quot;description&quot;: &quot;Flat Network Service Provider&quot;,
         &quot;lastOpDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
         &quot;name&quot;: &quot;Flat Network Service Provider&quot;,
         &quot;networkServiceTypes&quot;: [
             &quot;DHCP&quot;,
             &quot;Userdata&quot;
         ],
         &quot;type&quot;: &quot;Flat&quot;,
         &quot;uuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;
     },
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;加载Flat Network Provider的服务到三层网络&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;AttachNetworkServiceToL3Network l3NetworkUuid=1a82c2691978476fa6cefa36bb9d4bfd networkServices=&#39;{&quot;17864f985e584a9ba4cd81de215212ce&quot;:[&quot;DHCP&quot;,&quot;Userdata&quot;]}&#39;
 {
     &quot;inventory&quot;: {
         &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;dns&quot;: [
             &quot;8.8.8.8&quot;
         ],
         &quot;ipRanges&quot;: [
             {
                 &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;endIp&quot;: &quot;192.168.201.199&quot;,
                 &quot;gateway&quot;: &quot;192.168.200.1&quot;,
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;name&quot;: &quot;ipr-dk7p&quot;,
                 &quot;netmask&quot;: &quot;255.255.252.0&quot;,
                 &quot;startIp&quot;: &quot;192.168.201.180&quot;,
                 &quot;uuid&quot;: &quot;ec5fd87dd80243fdabeeace847c04427&quot;
             }
         ],
         &quot;l2NetworkUuid&quot;: &quot;9ec8cad681d1424fa7eda2447edae142&quot;,
         &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;name&quot;: &quot;l3-etpz&quot;,
         &quot;networkServices&quot;: [
             {
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;networkServiceProviderUuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;,
                 &quot;networkServiceType&quot;: &quot;DHCP&quot;
             },
             {
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;networkServiceProviderUuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;,
                 &quot;networkServiceType&quot;: &quot;Userdata&quot;
             }
         ],
         &quot;state&quot;: &quot;Enabled&quot;,
         &quot;system&quot;: false,
         &quot;type&quot;: &quot;L3BasicNetwork&quot;,
         &quot;uuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
         &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
     },
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;删除virtualrouter ,删除virtual router offering&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryVirtualRouterVm
 {
     &quot;inventories&quot;: [
         {
             &quot;allVolumes&quot;: [
                 {
                     &quot;createDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
                     &quot;description&quot;: &quot;Root volume for VM[uuid:c5a966cb87d644649952daf683f89e26]&quot;,
                     &quot;deviceId&quot;: 0,
                     &quot;format&quot;: &quot;qcow2&quot;,
                     &quot;installPath&quot;: &quot;/zstack_ps/rootVolumes/acct-36c27e8ff05c4780bf6d2fa65700f22e/vol-8eeaa9cb4c1045a2825f8815fed69d72/8eeaa9cb4c1045a2825f8815fed69d72.qcow2&quot;,
                     &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:06:59 PM&quot;,
                     &quot;name&quot;: &quot;ROOT-for-virtualRouter.l3.1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                     &quot;primaryStorageUuid&quot;: &quot;4bff4e2d266f480ead596752d14ff3b5&quot;,
                     &quot;rootImageUuid&quot;: &quot;7bed05aa8ace4e5e8d6c55b284b66fb5&quot;,
                     &quot;size&quot;: 467206656,
                     &quot;state&quot;: &quot;Enabled&quot;,
                     &quot;status&quot;: &quot;Ready&quot;,
                     &quot;type&quot;: &quot;Root&quot;,
                     &quot;uuid&quot;: &quot;8eeaa9cb4c1045a2825f8815fed69d72&quot;,
                     &quot;vmInstanceUuid&quot;: &quot;c5a966cb87d644649952daf683f89e26&quot;
                 }
             ],
             &quot;allocatorStrategy&quot;: &quot;LeastVmPreferredHostAllocatorStrategy&quot;,
             &quot;applianceVmType&quot;: &quot;VirtualRouter&quot;,
             &quot;clusterUuid&quot;: &quot;10409d3e33b249c19746022930a541c7&quot;,
             &quot;cpuNum&quot;: 1,
             &quot;cpuSpeed&quot;: 2,
             &quot;createDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
             &quot;defaultRouteL3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;hostUuid&quot;: &quot;415fa093b34e4a3d873368104b127115&quot;,
             &quot;hypervisorType&quot;: &quot;KVM&quot;,
             &quot;imageUuid&quot;: &quot;7bed05aa8ace4e5e8d6c55b284b66fb5&quot;,
             &quot;instanceOfferingUuid&quot;: &quot;9cec7bd6324445a184351ffb7d32f970&quot;,
             &quot;lastHostUuid&quot;: &quot;415fa093b34e4a3d873368104b127115&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:07:20 PM&quot;,
             &quot;managementNetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;memorySize&quot;: 536870912,
             &quot;name&quot;: &quot;virtualRouter.l3.1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;platform&quot;: &quot;Linux&quot;,
             &quot;publicNetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;rootVolumeUuid&quot;: &quot;8eeaa9cb4c1045a2825f8815fed69d72&quot;,
             &quot;state&quot;: &quot;Running&quot;,
             &quot;status&quot;: &quot;Connected&quot;,
             &quot;type&quot;: &quot;ApplianceVm&quot;,
             &quot;uuid&quot;: &quot;c5a966cb87d644649952daf683f89e26&quot;,
             &quot;vmNics&quot;: [
                 {
                     &quot;createDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
                     &quot;deviceId&quot;: 0,
                     &quot;gateway&quot;: &quot;192.168.200.1&quot;,
                     &quot;ip&quot;: &quot;192.168.201.195&quot;,
                     &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                     &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
                     &quot;mac&quot;: &quot;fa:4c:01:68:77:00&quot;,
                     &quot;metaData&quot;: &quot;7&quot;,
                     &quot;netmask&quot;: &quot;255.255.252.0&quot;,
                     &quot;uuid&quot;: &quot;c44e856aa88a42bc85ec30ce8c334c6c&quot;,
                     &quot;vmInstanceUuid&quot;: &quot;c5a966cb87d644649952daf683f89e26&quot;
                 }
             ],
             &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
         }
     ],
     &quot;success&quot;: true
 }

 &amp;gt;&amp;gt;&amp;gt;DestroyVmInstance uuid=c5a966cb87d644649952daf683f89e26
 {
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;重连所有有VM运行的host&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryHost
 {
     &quot;inventories&quot;: [
         {
             &quot;availableCpuCapacity&quot;: 7180,
             &quot;availableMemoryCapacity&quot;: 1997570048,
             &quot;clusterUuid&quot;: &quot;4282fb61aa55458ea160de138e130298&quot;,
             &quot;createDate&quot;: &quot;Jan 30, 2016 2:51:13 PM&quot;,
             &quot;hypervisorType&quot;: &quot;KVM&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:03:20 PM&quot;,
             &quot;managementIp&quot;: &quot;192.168.200.187&quot;,
             &quot;name&quot;: &quot;host1&quot;,
             &quot;state&quot;: &quot;Enabled&quot;,
             &quot;status&quot;: &quot;Connected&quot;,
             &quot;totalCpuCapacity&quot;: 7182,
             &quot;totalMemoryCapacity&quot;: 2098233344,
             &quot;username&quot;: &quot;root&quot;,
             &quot;uuid&quot;: &quot;402f8304a50c410486e023512492316b&quot;,
             &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
         },
         {
             &quot;availableCpuCapacity&quot;: 14363,
             &quot;availableMemoryCapacity&quot;: 8321593344,
             &quot;clusterUuid&quot;: &quot;10409d3e33b249c19746022930a541c7&quot;,
             &quot;createDate&quot;: &quot;Jan 30, 2016 3:03:14 PM&quot;,
             &quot;hypervisorType&quot;: &quot;KVM&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:03:52 PM&quot;,
             &quot;managementIp&quot;: &quot;192.168.200.150&quot;,
             &quot;name&quot;: &quot;host2&quot;,
             &quot;state&quot;: &quot;Enabled&quot;,
             &quot;status&quot;: &quot;Connected&quot;,
             &quot;totalCpuCapacity&quot;: 14364,
             &quot;totalMemoryCapacity&quot;: 8371924992,
             &quot;username&quot;: &quot;root&quot;,
             &quot;uuid&quot;: &quot;415fa093b34e4a3d873368104b127115&quot;,
             &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
         }
     ],
     &quot;success&quot;: true
 }

 &amp;gt;&amp;gt;&amp;gt;ReconnectHost uuid=402f8304a50c410486e023512492316b
 {
     &quot;success&quot;: true
 }

 &amp;gt;&amp;gt;&amp;gt;ReconnectHost uuid=415fa093b34e4a3d873368104b127115
 {
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;

</description>
        <pubDate>Mon, 25 Jan 2016 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/v1.0-rc1.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/v1.0-rc1.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
      <item>
        <title>ZStack v1.0发布</title>
        <description>&lt;h2&gt;ZStack 1.0 版本今天发布&lt;/h2&gt;

&lt;p&gt;ZStack 1.0版本今天发布，欢迎大家下载试用。在该版本中，我们加入了以下新功能。&lt;/p&gt;

&lt;h2&gt;新增功能&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#flatnetworkprovider&quot;&gt;Flat Network Provider，分布式DHCP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#userdata&quot;&gt;User Data，支持cloud-init&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#localstoragemigration&quot;&gt;本地存储的磁盘迁移&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#isoapi&quot;&gt;ISO API，支持加载/卸载ISO，调整VM启动顺序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#spice&quot;&gt;Spice支持&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#i18n&quot;&gt;i18n，支持中文、繁体中文、英文&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#vmstate&quot;&gt;VM状态实时捕获&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#deletionpolicy&quot;&gt;资源删除策略控制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#cpumodel&quot;&gt;CPU型号Passthrough，支持嵌套虚拟化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#zstackimage&quot;&gt;22M超小试用镜像&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;安装升级&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#install&quot;&gt;安装&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#upgrade&quot;&gt;升级&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#upgradenetwork&quot;&gt;Virtual Router Provider升级到Flat Network Porvider&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;h3 id=&quot;flatnetworkprovider&quot;&gt;1. Flat Network Provider&lt;/h3&gt;


&lt;p&gt;Flat Network Provider是一种新的网络服务提供模式，它提供DHCP和Userdata服务。相对于已有的Virtual Router Provider，Flat Network Provider最大的优势在于不需要启动一个Virtual Router虚拟机就可以为VM提供DHCP服务，这大大简化了部署一个扁平网络的复杂度。此外，由于采用了分布式DHCP系统，Flat Network Provider不存在传统DHCP系统的单点失败情况，因为每个物理机上都会有一个DHCP服务器服务运行在该物理机上的VM。在高并发创建或启动VM的时候，DHCP的负载会被分发到不同物理机上去，大大提供了系统整体的并发性。下图是分布式DHCP系统的一个总体架构图：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/1.0/1.PNG&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h3&gt;1.1 使用Flat Network Provider&lt;/h3&gt;

&lt;p&gt;当你在创建一个L3网络的时候，在最后一步选择网络服务时做如下操作：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/1.0/2.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;选择“Flat Network Service Provider&quot;做为网络服务提供商&lt;/li&gt;
&lt;li&gt;选择DHCP服务&lt;/li&gt;
&lt;li&gt;点击“添加”按钮&lt;/li&gt;
&lt;li&gt;重复步骤2和3添加user data服务&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;bs-callout bs-callout-info&quot;&gt;
&lt;h4&gt;你可以将Flat Network Provider和Virtual Router Provider混合使用&lt;/h4&gt;
尽管Flat Network Provider的主要目的是为扁平网络情况提供DHCP服务器，你也可以讲它跟已有的Virtual Router Provider混合使用。
例如使用Flat Network Provider提供DHCP，用Virtual Router Provider提供DNS/SNAT等其他服务。
&lt;/div&gt;




&lt;h3 id=&quot;userdata&quot;&gt; 2. User Data &lt;/h3&gt;


&lt;p&gt;标准的&lt;a href=&quot;https://cloudinit.readthedocs.org/en/latest/&quot;&gt;Cloud-init&lt;/a&gt;在该版本中得到支持。要使用user data，你需要在VM的操作系统中安装cloud-init包。User data使用了ZStack的系统标签（System Tags）机制实现，其格式为：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    userdata::{the content}
    例如：
    userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;你应该已经注意到了上面的user data中包含了一个非常长的字符串，它其实是cloud-init的YAML配置文件minify后的结果。因为ZStack的CLI工具只能接受单行字符串，在传递cloud-init YAML配置的时候你需要先把它变成一个单行的字符串。你可以使用下面脚本：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    sed &#39;:a;N;$!ba;s/\n/\\n/g&#39; YAML文件路径
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;输出的长字符串会打印到屏幕，你可以复制黏贴。&lt;/p&gt;

&lt;h3&gt;2.1 使用User Data&lt;/h3&gt;

&lt;p&gt;当你在VM的操作系统中安装完cloud-init包后，我们强烈建议你把它保存成一个模板，这样从该模板新建的VM都会有cloud-init的包。使用下面步骤安装cloud-init包：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;yum install cloud-init 或 apt-get install cloud-init&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在/etc/cloud/cloud.cfg文件中添加如下内容：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; datasource_list:
   - CloudStack
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;cloud-init支持AWS，CloudStack，OpenStack多种获取user data的方式，ZStack使用的是CloudStack方式，即用DHCP服务器提供user data。&lt;/p&gt;

&lt;h4&gt;2.1.1 添加User Data&lt;/h4&gt;

&lt;p&gt;你可以在新建VM的时候指定user data：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateVmInstance name=vm imageUuid=d720ff0c60ee48d3a2e6263dd3e12c33 instanceOfferingUuid=76789b62aeb542a5b4b8b8488fbaced2 l3NetworkUuids=37d3c4a1e2f14a1c8316a23531e62988,05266285f96245f096f3b7dce671991d defaultL3NetworkUuid=05266285f96245f096f3b7dce671991d systemTags=&#39;userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;或者对一个已经创建的VM指定user data：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateSystemTag resourceUuid=303bf80af28c4e23b9b8c20d4267356b resourceType=VmInstanceVO tag=&#39;userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;resourceUuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h4&gt;2.1.2 获得user data&lt;/h4&gt;

&lt;p&gt;你可以用&lt;code&gt;QuerySystemTag&lt;/code&gt;获取一个VM的user data，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    QuerySystemTag resourceUuid=303bf80af28c4e23b9b8c20d4267356b tag~=userdata%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;resourceUuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h4&gt;2.1.3 删除user data&lt;/h4&gt;

&lt;p&gt;你可以用&lt;code&gt;DeleteTag&lt;/code&gt;从一个VM上删除user data，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    DeleteTag uuid=user_data_tag_uuid
    例如：
    DeleteTag uuid=7813d03bb85840c489789f8df3a5915b
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取user data一节的方法拿到。&lt;/p&gt;

&lt;h4&gt;2.1.4 更新user data&lt;/h4&gt;

&lt;p&gt;你可以用&lt;code&gt;UpdateSystemTag&lt;/code&gt;更新一个VM上已有的user data，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateSystemTag uuid=762c3047e05f471ea3fce13f808a50be tag=&#39;userdata::groups:\n  - ubuntu: [foo,bar]\n  - cloud-users\n\n# Add users to the system. Users are added after groups are added.\nusers:\n  - default\n  - name: foobar\n    gecos: Foo B. Bar\n    primary-group: foobar\n    groups: users\n    selinux-user: staff_u\n    expiredate: 2012-09-01\n    ssh-import-id: foobar\n    lock-passwd: false\n  - name: barfoo\n    gecos: Bar B. Foo\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    groups: users, admin\n    ssh-import-id: None\n    lock-passwd: true\n    ssh-authorized-keys:\n      - &amp;lt;ssh pub key 1&amp;gt;\n      - &amp;lt;ssh pub key 2&amp;gt;\n  - name: cloudy\n    gecos: Magic Cloud App Daemon User\n    inactive: true\n    system: true&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取user data一节的方法拿到。&lt;/p&gt;

&lt;h4&gt;2.2 注入SSH公钥&lt;/h4&gt;

&lt;p&gt;SSH公钥是用户使用user data最常见的用法，为此我们特别提供了一个专门的system tag，格式为：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    sshkey::{content}
    例如：
    sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5x3AoWuiZawxXoBxEcOhhdVAST4kJA/cQ2zGnh3yZ/KBU+VILQHTkbNWAaRw3q0UtfpLfVj/KoPFr43qjGF+ud8B/rD7stsAvbNVdms81aBDAFZyiN7dhlwTK+XvCMhl4RxHUItm7+Y7gzb8jTHPoqlPzAw4r8enqhNf9ABG+kaXIDa0FPhVaMPoLzHWjTe34ONIBlxsY/y1Zle49vPVYS7oAHQTc7ly7bnGXffNJ18uF5M7HPUgsIDum8KICa2LmnXJeB2M9XZtXtJUdR1ZKXeQpRtikAm3G3CwFkDxWnx31dGr0lLa2aZ88LQ2iP8nb2NK58aKb4I9Aq19k44Rl root@yyy
&lt;/code&gt;&lt;/pre&gt;

&lt;h5&gt;2.2.1 注入SSH公钥&lt;/h5&gt;

&lt;p&gt;你可以在创建VM的时候指定公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateVmInstance name=vm imageUuid=d720ff0c60ee48d3a2e6263dd3e12c33 instanceOfferingUuid=76789b62aeb542a5b4b8b8488fbaced2 l3NetworkUuids=37d3c4a1e2f14a1c8316a23531e62988,05266285f96245f096f3b7dce671991d defaultL3NetworkUuid=05266285f96245f096f3b7dce671991d systemTags=&#39;sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5x3AoWuiZawxXoBxEcOhhdVAST4kJA/cQ2zGnh3yZ/KBU+VILQHTkbNWAaRw3q0UtfpLfVj/KoPFr43qjGF+ud8B/rD7stsAvbNVdms81aBDAFZyiN7dhlwTK+XvCMhl4RxHUItm7+Y7gzb8jTHPoqlPzAw4r8enqhNf9ABG+kaXIDa0FPhVaMPoLzHWjTe34ONIBlxsY/y1Zle49vPVYS7oAHQTc7ly7bnGXffNJ18uF5M7HPUgsIDum8KICa2LmnXJeB2M9XZtXtJUdR1ZKXeQpRtikAm3G3CwFkDxWnx31dGr0lLa2aZ88LQ2iP8nb2NK58aKb4I9Aq19k44Rl root@yyy&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;也可以给一个已有的VM指定公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    CreateSystemTag resourceType=VmInstanceVO resourceUuid=606d9a2fa723407c93438789eaf72cea tag=&quot;sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDdlfgEu4SmgAXaEhLtNljm4cqowdFSyOH7NtheqzZROaRNRJOYKCABUZLmsLv1pl3Av+m1vUUILPWNymxdCnhuaxl/vFtvyWrLChKR8s2Cpl24uFpvHaWO6JLd/RnSwj8LCsCreJ3Twq77T9MCwDVl15WNjn3WKuPfFKxmW7gQTDyDK1XX35n7RYSadurdVNmJTAsQWmszmGeBDVO6U7spRtH7nNrNAMVjaOHrPp5NbMRBVCyHfj1UY71bnIdVCa2mY/RtjIkcj4JNBaQ0JPnP1jw4Ig8WVkjn74T7U4chUHmu8jzwhv+++F7EGLSNdb85RKmY5IdHDd+dRuK3Rx67 root@bji-bm-node3&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h5&gt;2.2.2 获得公钥&lt;/h5&gt;

&lt;p&gt;你可以用&lt;code&gt;QuerySystemTag&lt;/code&gt;获得一个VM的公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    QuerySystemTag resourceUuid=303bf80af28c4e23b9b8c20d4267356b tag~=sshkey%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;resourceUuid&lt;/code&gt;是VM的UUID&lt;/p&gt;

&lt;h5&gt;2.2.3 删除公钥&lt;/h5&gt;

&lt;p&gt;你可以用&lt;code&gt;DeleteTag&lt;/code&gt;从VM上删除一个公钥：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    DeleteTag uuid=user_data_tag_uuid
    例如：
    DeleteTag uuid=7813d03bb85840c489789f8df3a5915b
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取公钥一节的方法拿到。&lt;/p&gt;

&lt;h5&gt;2.2.4 更新公钥&lt;/h5&gt;

&lt;p&gt;你可以使用&lt;code&gt;UpdateSystemTag&lt;/code&gt;更新一个VM的公钥，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateSystemTag uuid=762c3047e05f471ea3fce13f808a50be tag=&#39;sshkey::ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDdlfgEu4SmgAXaEhLtNljm4cqowdFSyOH7Nthe    qzZROaRNRJOYKCABUZLmsLv1pl3Av+m1vUUILPWNymxdCnhuaxl/vFtvyWrLChKR8s2Cpl24uFpvHaWO6JLd/RnSwj8LCsCreJ3Twq77T9MCwDVl15WNjn3WKuPfFKxmW7gQTDyDK1XX35n7RYSadurdVNmJTAsQWmszmGeBDVO6U7spRtH7nNrNA    MVjaOHrPp5NbMRBVCyHfj1UY71bnIdVCa2mY/RtjIkcj4JNBaQ0JPnP1jw4Ig8WVkjn74T7U4chUHmu8jzwhv+++F7EGLSNdb85RKmY5IdHDd+dRuK3Rx67 root@bji-bm-node3&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的UUID是system tag的UUID，你可以用获取公钥一节的方法拿到。&lt;/p&gt;

&lt;div class=&quot;bs-callout bs-callout-warning&quot;&gt;
&lt;h4&gt;你或许需要重启VM让公钥生效&lt;/h4&gt;

如果你是给一个已有的VM创建公钥或者更新公钥，你需要做如下步骤：&lt;br&gt;
1. 删除在VM中删除已有的cloud-init数据，rm -rf /var/lib/cloud&lt;br&gt;
2. 重启VM&lt;br&gt;

对于给新建的VM指定公钥，你无需做这些步骤。
&lt;/div&gt;




&lt;h3 id=&quot;localstoragemigration&quot;&gt; 3. 本地存储的磁盘迁移 &lt;/h3&gt;


&lt;p&gt;在本版本中，你可以在本地存储的不同物理机间迁移虚拟机的磁盘(volume)，解决使用本地存储虚拟机不能迁移的的问题。&lt;/p&gt;

&lt;h3&gt;3.1 迁移磁盘&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;LocalStorageMigrateVolume&lt;/code&gt;迁移VM的root volume和data volume。例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    LocalStorageMigrateVolume volumeUuid=cdbda88fef1a42f386ff111b729159d9 destHostUuid=252d484d93e64fea946148097162b60f
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;3.2 迁移规则&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;如果迁移的是root volume，需要先关闭虚拟机&lt;/li&gt;
&lt;li&gt;如果迁移的是data volume，需要先将data volume从虚拟机卸载（detach)&lt;/li&gt;
&lt;li&gt;如果volume上有快照（snapshots），快照会被一并迁移&lt;/li&gt;
&lt;/ol&gt;


&lt;h3&gt;3.3 使用磁盘迁移迁移VM&lt;/h3&gt;

&lt;p&gt;你可以使用磁盘迁移功能在不同物理机上冷迁移虚拟机：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;关闭虚拟机&lt;/li&gt;
&lt;li&gt;将虚拟机的root volume迁移到目的物理机&lt;/li&gt;
&lt;li&gt;启动虚拟机&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;&lt;p&gt;ZStack实际是支持本地存储的虚拟机热迁移的。但在我们的压力测试中，我们发现KVM的带存储热迁移不稳定。我们在一个虚拟机中做一次Linux内核编译，并在这个过程中做带存储热迁移，迁移完成后重启虚拟机，发现虚拟机磁盘损坏。为了保护用户数据，我们在API层面关闭了虚拟机带存储热迁移的功能。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h3 id=&quot;isoapi&quot;&gt; 4. ISO API &lt;/h3&gt;


&lt;p&gt;在该版本中，你可以使用API向一个VM加载或卸载一个ISO，并且改变VM的启动设备顺序。&lt;/p&gt;

&lt;h3&gt;4.1 添加ISO&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;AttachIsoToVmInstance&lt;/code&gt;向一个VM添加一个ISO，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    AttachIsoToVmInstance vmInstanceUuid=d4a83b0394b44482bbcb964b4dbe991c isoUuid=815dcd3d83dd429298ba2c9b1685c1ad
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;4.2 卸载ISO&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;DetachIsoFromVmInstance&lt;/code&gt;从一个VM上卸载一个ISO，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    DetachIsoFromVmInstance vmInstanceUuid=d4a83b0394b44482bbcb964b4dbe991c
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h3&gt;4.3 设置启动设备顺序&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;SetVmBootOrder&lt;/code&gt;设置VM的启动设备顺序，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    SetVmBootOrder uuid=303bf80af28c4e23b9b8c20d4267356b bootOrder=HardDisk,CdRom
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;合法的启动顺序包括：HardDisk和CdRom&lt;/p&gt;&lt;/blockquote&gt;

&lt;h3&gt;4.4 获得启动设备顺序&lt;/h3&gt;

&lt;p&gt;你可以用&lt;code&gt;GetVmBootOrder&lt;/code&gt;获得VM的启动设备顺序，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    GetVmBootOrder uuid=303bf80af28c4e23b9b8c20d4267356b
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。&lt;/p&gt;

&lt;h3&gt;4.5 设备启动顺序规则&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;如果使用ISO创建一个VM，则该VM的启动设备自动被设置为CdRom。当操作系统安装完成并重启后，启动顺序自动改成HardDisk&lt;/li&gt;
&lt;li&gt;如果使用template创建一个VM，改VM的启动设备自动被设置为HardDisk&lt;/li&gt;
&lt;li&gt;加载一个ISO到一个VM不改变其启动顺序。如果需要，你可以用&lt;code&gt;SetVmBootOrder&lt;/code&gt;更改&lt;/li&gt;
&lt;/ul&gt;


&lt;h3 id=&quot;spice&quot;&gt; 5. Spice支持 &lt;/h3&gt;


&lt;p&gt;在该版本中，我们支持Spice协议作为VM图形终端协议。你可以通过更改全局选项进行设置，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=kvm name=vm.consoleMode value=spice
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;合法的协议包括：vnc和spice&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;目前ZStack还没有针对spice的console proxy，你需要下载一个spice客户端直接连接VM在物理机上的spice端口。你可以用下面的API来获得物理机的IP和VM的spice端口号：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    &amp;gt;&amp;gt;&amp;gt;GetVmConsoleAddress uuid=9cd68155905e47b5b0698ecba9126242
    {
        &quot;hostIp&quot;: &quot;192.168.199.136&quot;,
        &quot;port&quot;: 5902,
        &quot;protocol&quot;: &quot;spice&quot;,
        &quot;success&quot;: true
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这里的&lt;code&gt;uuid&lt;/code&gt;是VM的UUID。感谢来至武汉纺织大学的Nan Su(fengcai_ji@163.com)同学贡献了这个功能。&lt;/p&gt;

&lt;h3 id=&quot;i18n&quot;&gt; 6. I18N支持 &lt;/h3&gt;


&lt;p&gt;在该版本中，我们支持多语言版本，目前支持英文和中文，你可以通过点击语言图标进行切换。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/1.0/3.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;感谢来自武汉纺织大学的Nan Su(fengcai_ji@163.com), Zhiqiang Hu(1063751150@qq.com)u Qi Wei(804470533@qq.com), Yu Chen(ppak@sohu.com), Wanling Xue(1962670706@qq.com)贡献了该功能！&lt;/p&gt;

&lt;p&gt;感谢台湾&lt;a href=&quot;http://www.baiyuan.com.tw/&quot;&gt;百原科技&lt;/a&gt;提供繁体版UI翻译！&lt;/p&gt;

&lt;h3 id=&quot;vmstate&quot;&gt; 7. VM状态的实时捕获 &lt;/h3&gt;


&lt;p&gt;在该版本中，我们支持VM状态的实时捕获。如果用户绕过ZStack对VM进行了操作，其状态会实时的发送回管理节点进行更新。也就是说你可以在VM内部
通过halt命令来关闭虚拟机，而不用通过ZStack UI。虽然不推荐，但如果你用virsh关闭或者启动了一个VM，其在ZStack中的状态也会被实时更新。&lt;/p&gt;

&lt;h3 id=&quot;deletionpolicy&quot;&gt; 8. 资源删除策略控制 &lt;/h3&gt;


&lt;p&gt;从该版本开始，我们对一些关键资源实现了删除策略控制，用户可以控制资源的删除方式，以防误删除。目前支持删除策略控制的资源包括：虚拟机、磁盘(volume)、镜像（image）。目前支持的删除策略包括：&lt;strong&gt;Direct（直接删除）&lt;/strong&gt;, &lt;strong&gt;Delay（延时删除）&lt;/strong&gt;, &lt;strong&gt;Never（从不删除）&lt;/strong&gt;三种。默认的策略是Delay。&lt;/p&gt;

&lt;h3&gt;8.1 策略规则&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Direct: 资源会直接被物理删除，并在数据库中删除，无法恢复。&lt;/li&gt;
&lt;li&gt;Delay：资源会首先在数据库中被标记成删除，但不会物理删除。在一定的时间内，用户可以使用API对资源进行恢复，在此期间资源仍然物理存在，所以它还会占用物理空间（例如磁盘空间）。在超过一定时间后，资源会被物理删除，无法再恢复。&lt;/li&gt;
&lt;li&gt;Never：资源数据库中标记成删除，永远不会被物理删除，一直占用物理空间。&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;8.2 虚拟机删除策略&lt;/h3&gt;

&lt;p&gt;你可以更改虚拟机的删除策略，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=vm name=deletionPolicy value=Direct
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果删除策略是Delay，你可以指定延时删除的时间，例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=vm name=expungePeriod value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;单位为秒。在上面的例子中，虚拟机在被标记成删除后的1个小时后被测地删除。&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;如果删除策略是Delay，ZStack会周期性的去检查资源是否应该被物理删除，你可以控制周期性轮询的时间：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=vm name=expungeInterval value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;单位为秒&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;你也可以恢复一个处于删除状态的虚拟机：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverVmInstance vmInstanceUuid=8c4c4c0bbac7441fb056d0d6e2168996
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;8.3 镜像删除策略&lt;/h3&gt;

&lt;p&gt;跟虚拟机一样，你可以改变相应的设置：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=image name=deletionPolicy value=Direct
    UpdateGlobalConfig category=image name=expungePeriod value=3600
    UpdateGlobalConfig category=image name=expungeInterval value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;也可以恢复一个处于删除状态的镜像：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverImage imageUuid=8c4c4c0bbac7441fb056d0d6e2168996
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果镜像存在于多个备份存储，你只想恢复在某些备份存储上的镜像，可以通过额外参数指定：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverImage imageUuid=8c4c4c0bbac7441fb056d0d6e2168996 backupStorageUuids=36c27e8ff05c4780bf6d2fa65700f22e
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;8.4 磁盘删除策略&lt;/h3&gt;

&lt;p&gt;跟虚拟机一样，你可以通过改变相应的设置：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=volume name=deletionPolicy value=Direct
    UpdateGlobalConfig category=volume name=expungePeriod value=3600
    UpdateGlobalConfig category=volume name=expungeInterval value=3600
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;你也可以恢复一个处于删除状态数据磁盘(data volume)：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    RecoverDataVolume uuid=36c27e8ff05c4780bf6d2fa65700f22e
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;根磁盘(root volume)的恢复是在恢复虚拟机的时候自动恢复。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h3 id=&quot;cpumodel&quot;&gt; 9. CPU型号Paasthrough(支持嵌套虚拟化) &lt;/h3&gt;


&lt;p&gt;你可以通过改变全局配置让虚拟机获得跟物理机CPU相同的型号：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    UpdateGlobalConfig category=kvm name=vm.cpuMode value=host-model
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;支持三种模式：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;none: CPU型号为QEMU模拟器&lt;/li&gt;
&lt;li&gt;host-model：CPU类型为物理机CPU类型&lt;/li&gt;
&lt;li&gt;host-passthrough：CPU型号跟物理机CPU完全一样&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;当模式为&lt;code&gt;host-model&lt;/code&gt;和&lt;code&gt;host-passthrough&lt;/code&gt;时，虚拟机可以获得嵌套虚拟化功能。&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;使用该功能可能会影响虚拟机热迁移。因为热迁移时会检查虚拟机CPU型号，如果两台物理机的CPU型号不同，会导致虚拟机热迁移失败。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h3 id=&quot;zstackimage&quot;&gt; 10. 超小试用镜像 &lt;/h3&gt;


&lt;p&gt;在1.0我们为ZStack专门构建了一个只有22M的测试镜像，用户在部署了ZStack后可以下载用于基本测试目的。先比于之前ZStack使用的ttylinux，新镜像支持ACPID，通过ZStack关机的时候能够响应ACPID命令。下载链接：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;     http://download.zstack.org/templates/zstack-image-0.0.7.qcow2
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;install&quot;&gt; 11. 安装 &lt;/h3&gt;


&lt;p&gt;你可以通过下面方式安装：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    wget http://download.zstack.org/releases/1.0/1.0.0/zstack-installer-1.0.0-0201.bin -O zstack-installer-1.0.0-0201.bin
    bash zstack-installer-1.0.0-0201.bin -R aliyun
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;这里&lt;code&gt;-R aliyun&lt;/code&gt;参数指定使用阿里云的源进行安装，你也可以使用&lt;code&gt;-R 163&lt;/code&gt;使用网易的源。我们推荐使用阿里云的源&lt;/p&gt;&lt;/blockquote&gt;

&lt;h3 id=&quot;upgrade&quot;&gt; 12. 升级 &lt;/h3&gt;


&lt;p&gt;一如既往的，我们支持一键无缝升级：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    wget http://download.zstack.org/releases/1.0/1.0.0/zstack-installer-1.0.0-0201.bin -O zstack-installer-1.0.0-0201.bin
    bash zstack-installer-1.0.0-0201.bin -u
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;&lt;p&gt;如果你安装了多个管理节点，请等待最终GA版本的升级步骤。这里的升级步骤只适合all-in-one安装的ZStack。&lt;/p&gt;&lt;/blockquote&gt;

&lt;h3 id=&quot;upgradenetwork&quot;&gt; 13. 用Flat Network Provider替换Virtual Router Provider &lt;/h3&gt;


&lt;p&gt;如果你的网络模式是扁平网络，并且使用的是Virtual Rotuer Provider作为网络提供商，你可以使用1.0的Flat Network Provider替换它，这样你就不再需要virtual router VM来充当DHCP服务器了。假定你要替换网络提供商的L3网络的UUID是1a82c2691978476fa6cefa36bb9d4bfd，参考以下步骤：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;获得当前L3网络的网络提供商UUID&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryNetworkServiceL3NetworkRef l3NetworkUuid=1a82c2691978476fa6cefa36bb9d4bfd
 {
     &quot;inventories&quot;: [
         {
             &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;networkServiceProviderUuid&quot;: &quot;5d21ea0f39c04d6fb68cfaf5a37db4ad&quot;,
             &quot;networkServiceType&quot;: &quot;DNS&quot;
         },
         {
             &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;networkServiceProviderUuid&quot;: &quot;5d21ea0f39c04d6fb68cfaf5a37db4ad&quot;,
             &quot;networkServiceType&quot;: &quot;DHCP&quot;
         }
     ],
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;从L3网络上卸载Virtual Router Provider&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;DetachNetworkServiceFromL3Network  l3NetworkUuid=1a82c2691978476fa6cefa36bb9d4bfd networkServices=&#39;{&quot;5d21ea0f39c04d6fb68cfaf5a37db4ad&quot;:[&quot;DHCP&quot;,&quot;DNS&quot;]}&#39;
 {
     &quot;inventory&quot;: {
         &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;dns&quot;: [
             &quot;8.8.8.8&quot;
         ],
         &quot;ipRanges&quot;: [
             {
                 &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;endIp&quot;: &quot;192.168.201.199&quot;,
                 &quot;gateway&quot;: &quot;192.168.200.1&quot;,
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;name&quot;: &quot;ipr-dk7p&quot;,
                 &quot;netmask&quot;: &quot;255.255.252.0&quot;,
                 &quot;startIp&quot;: &quot;192.168.201.180&quot;,
                 &quot;uuid&quot;: &quot;ec5fd87dd80243fdabeeace847c04427&quot;
             }
         ],
         &quot;l2NetworkUuid&quot;: &quot;9ec8cad681d1424fa7eda2447edae142&quot;,
         &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;name&quot;: &quot;l3-etpz&quot;,
         &quot;networkServices&quot;: [],
         &quot;state&quot;: &quot;Enabled&quot;,
         &quot;system&quot;: false,
         &quot;type&quot;: &quot;L3BasicNetwork&quot;,
         &quot;uuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
         &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
     },
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;&lt;p&gt;注意这里的参数networkServices是一个map， key是第一步里返回的networkServiceProviderUuid，value是第一步里返回的networkServiceType&lt;/p&gt;&lt;/blockquote&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;获得Flat Network Provider的UUID&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryNetworkServiceProvider type=Flat
 {
     &quot;inventories&quot;: [
         {
             &quot;attachedL2NetworkUuids&quot;: [
                 &quot;9ec8cad681d1424fa7eda2447edae142&quot;
             ],
             &quot;createDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
             &quot;description&quot;: &quot;Flat Network Service Provider&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
             &quot;name&quot;: &quot;Flat Network Service Provider&quot;,
             &quot;networkServiceTypes&quot;: [
                 &quot;DHCP&quot;,
                 &quot;Userdata&quot;
             ],
             &quot;type&quot;: &quot;Flat&quot;,
             &quot;uuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;
         }
     ],
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;获得承载L3网络的L2网络的UUID&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryL3Network fields=l2NetworkUuid, uuid=1a82c2691978476fa6cefa36bb9d4bfd
 {
     &quot;inventories&quot;: [
         {
             &quot;l2NetworkUuid&quot;: &quot;9ec8cad681d1424fa7eda2447edae142&quot;
         }
     ],
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;加载Flat Network Provider到L2网络&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;AttachNetworkServiceProviderToL2Network l2NetworkUuid=9ec8cad681d1424fa7eda2447edae142 networkServiceProviderUuid=17864f985e584a9ba4cd81de215212ce
 {
     &quot;inventory&quot;: {
         &quot;attachedL2NetworkUuids&quot;: [
             &quot;9ec8cad681d1424fa7eda2447edae142&quot;
         ],
         &quot;createDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
         &quot;description&quot;: &quot;Flat Network Service Provider&quot;,
         &quot;lastOpDate&quot;: &quot;Jan 30, 2016 11:56:32 AM&quot;,
         &quot;name&quot;: &quot;Flat Network Service Provider&quot;,
         &quot;networkServiceTypes&quot;: [
             &quot;DHCP&quot;,
             &quot;Userdata&quot;
         ],
         &quot;type&quot;: &quot;Flat&quot;,
         &quot;uuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;
     },
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;加载Flat Network Provider的服务到三层网络&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;AttachNetworkServiceToL3Network l3NetworkUuid=1a82c2691978476fa6cefa36bb9d4bfd networkServices=&#39;{&quot;17864f985e584a9ba4cd81de215212ce&quot;:[&quot;DHCP&quot;,&quot;Userdata&quot;]}&#39;
 {
     &quot;inventory&quot;: {
         &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;dns&quot;: [
             &quot;8.8.8.8&quot;
         ],
         &quot;ipRanges&quot;: [
             {
                 &quot;createDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;endIp&quot;: &quot;192.168.201.199&quot;,
                 &quot;gateway&quot;: &quot;192.168.200.1&quot;,
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:04 PM&quot;,
                 &quot;name&quot;: &quot;ipr-dk7p&quot;,
                 &quot;netmask&quot;: &quot;255.255.252.0&quot;,
                 &quot;startIp&quot;: &quot;192.168.201.180&quot;,
                 &quot;uuid&quot;: &quot;ec5fd87dd80243fdabeeace847c04427&quot;
             }
         ],
         &quot;l2NetworkUuid&quot;: &quot;9ec8cad681d1424fa7eda2447edae142&quot;,
         &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:01:03 PM&quot;,
         &quot;name&quot;: &quot;l3-etpz&quot;,
         &quot;networkServices&quot;: [
             {
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;networkServiceProviderUuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;,
                 &quot;networkServiceType&quot;: &quot;DHCP&quot;
             },
             {
                 &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                 &quot;networkServiceProviderUuid&quot;: &quot;17864f985e584a9ba4cd81de215212ce&quot;,
                 &quot;networkServiceType&quot;: &quot;Userdata&quot;
             }
         ],
         &quot;state&quot;: &quot;Enabled&quot;,
         &quot;system&quot;: false,
         &quot;type&quot;: &quot;L3BasicNetwork&quot;,
         &quot;uuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
         &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
     },
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;删除virtualrouter ,删除virtual router offering&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryVirtualRouterVm
 {
     &quot;inventories&quot;: [
         {
             &quot;allVolumes&quot;: [
                 {
                     &quot;createDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
                     &quot;description&quot;: &quot;Root volume for VM[uuid:c5a966cb87d644649952daf683f89e26]&quot;,
                     &quot;deviceId&quot;: 0,
                     &quot;format&quot;: &quot;qcow2&quot;,
                     &quot;installPath&quot;: &quot;/zstack_ps/rootVolumes/acct-36c27e8ff05c4780bf6d2fa65700f22e/vol-8eeaa9cb4c1045a2825f8815fed69d72/8eeaa9cb4c1045a2825f8815fed69d72.qcow2&quot;,
                     &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:06:59 PM&quot;,
                     &quot;name&quot;: &quot;ROOT-for-virtualRouter.l3.1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                     &quot;primaryStorageUuid&quot;: &quot;4bff4e2d266f480ead596752d14ff3b5&quot;,
                     &quot;rootImageUuid&quot;: &quot;7bed05aa8ace4e5e8d6c55b284b66fb5&quot;,
                     &quot;size&quot;: 467206656,
                     &quot;state&quot;: &quot;Enabled&quot;,
                     &quot;status&quot;: &quot;Ready&quot;,
                     &quot;type&quot;: &quot;Root&quot;,
                     &quot;uuid&quot;: &quot;8eeaa9cb4c1045a2825f8815fed69d72&quot;,
                     &quot;vmInstanceUuid&quot;: &quot;c5a966cb87d644649952daf683f89e26&quot;
                 }
             ],
             &quot;allocatorStrategy&quot;: &quot;LeastVmPreferredHostAllocatorStrategy&quot;,
             &quot;applianceVmType&quot;: &quot;VirtualRouter&quot;,
             &quot;clusterUuid&quot;: &quot;10409d3e33b249c19746022930a541c7&quot;,
             &quot;cpuNum&quot;: 1,
             &quot;cpuSpeed&quot;: 2,
             &quot;createDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
             &quot;defaultRouteL3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;hostUuid&quot;: &quot;415fa093b34e4a3d873368104b127115&quot;,
             &quot;hypervisorType&quot;: &quot;KVM&quot;,
             &quot;imageUuid&quot;: &quot;7bed05aa8ace4e5e8d6c55b284b66fb5&quot;,
             &quot;instanceOfferingUuid&quot;: &quot;9cec7bd6324445a184351ffb7d32f970&quot;,
             &quot;lastHostUuid&quot;: &quot;415fa093b34e4a3d873368104b127115&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:07:20 PM&quot;,
             &quot;managementNetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;memorySize&quot;: 536870912,
             &quot;name&quot;: &quot;virtualRouter.l3.1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;platform&quot;: &quot;Linux&quot;,
             &quot;publicNetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
             &quot;rootVolumeUuid&quot;: &quot;8eeaa9cb4c1045a2825f8815fed69d72&quot;,
             &quot;state&quot;: &quot;Running&quot;,
             &quot;status&quot;: &quot;Connected&quot;,
             &quot;type&quot;: &quot;ApplianceVm&quot;,
             &quot;uuid&quot;: &quot;c5a966cb87d644649952daf683f89e26&quot;,
             &quot;vmNics&quot;: [
                 {
                     &quot;createDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
                     &quot;deviceId&quot;: 0,
                     &quot;gateway&quot;: &quot;192.168.200.1&quot;,
                     &quot;ip&quot;: &quot;192.168.201.195&quot;,
                     &quot;l3NetworkUuid&quot;: &quot;1a82c2691978476fa6cefa36bb9d4bfd&quot;,
                     &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:06:50 PM&quot;,
                     &quot;mac&quot;: &quot;fa:4c:01:68:77:00&quot;,
                     &quot;metaData&quot;: &quot;7&quot;,
                     &quot;netmask&quot;: &quot;255.255.252.0&quot;,
                     &quot;uuid&quot;: &quot;c44e856aa88a42bc85ec30ce8c334c6c&quot;,
                     &quot;vmInstanceUuid&quot;: &quot;c5a966cb87d644649952daf683f89e26&quot;
                 }
             ],
             &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
         }
     ],
     &quot;success&quot;: true
 }

 &amp;gt;&amp;gt;&amp;gt;DestroyVmInstance uuid=c5a966cb87d644649952daf683f89e26
 {
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;重连所有有VM运行的host&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; &amp;gt;&amp;gt;&amp;gt;QueryHost
 {
     &quot;inventories&quot;: [
         {
             &quot;availableCpuCapacity&quot;: 7180,
             &quot;availableMemoryCapacity&quot;: 1997570048,
             &quot;clusterUuid&quot;: &quot;4282fb61aa55458ea160de138e130298&quot;,
             &quot;createDate&quot;: &quot;Jan 30, 2016 2:51:13 PM&quot;,
             &quot;hypervisorType&quot;: &quot;KVM&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:03:20 PM&quot;,
             &quot;managementIp&quot;: &quot;192.168.200.187&quot;,
             &quot;name&quot;: &quot;host1&quot;,
             &quot;state&quot;: &quot;Enabled&quot;,
             &quot;status&quot;: &quot;Connected&quot;,
             &quot;totalCpuCapacity&quot;: 7182,
             &quot;totalMemoryCapacity&quot;: 2098233344,
             &quot;username&quot;: &quot;root&quot;,
             &quot;uuid&quot;: &quot;402f8304a50c410486e023512492316b&quot;,
             &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
         },
         {
             &quot;availableCpuCapacity&quot;: 14363,
             &quot;availableMemoryCapacity&quot;: 8321593344,
             &quot;clusterUuid&quot;: &quot;10409d3e33b249c19746022930a541c7&quot;,
             &quot;createDate&quot;: &quot;Jan 30, 2016 3:03:14 PM&quot;,
             &quot;hypervisorType&quot;: &quot;KVM&quot;,
             &quot;lastOpDate&quot;: &quot;Jan 30, 2016 3:03:52 PM&quot;,
             &quot;managementIp&quot;: &quot;192.168.200.150&quot;,
             &quot;name&quot;: &quot;host2&quot;,
             &quot;state&quot;: &quot;Enabled&quot;,
             &quot;status&quot;: &quot;Connected&quot;,
             &quot;totalCpuCapacity&quot;: 14364,
             &quot;totalMemoryCapacity&quot;: 8371924992,
             &quot;username&quot;: &quot;root&quot;,
             &quot;uuid&quot;: &quot;415fa093b34e4a3d873368104b127115&quot;,
             &quot;zoneUuid&quot;: &quot;4a3a78b1b9f049948b79cf9e667f0af2&quot;
         }
     ],
     &quot;success&quot;: true
 }

 &amp;gt;&amp;gt;&amp;gt;ReconnectHost uuid=402f8304a50c410486e023512492316b
 {
     &quot;success&quot;: true
 }

 &amp;gt;&amp;gt;&amp;gt;ReconnectHost uuid=415fa093b34e4a3d873368104b127115
 {
     &quot;success&quot;: true
 }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;

</description>
        <pubDate>Mon, 25 Jan 2016 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/v1.0.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/v1.0.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
      <item>
        <title>给ZStack添加SPice协议的支持（一）</title>
        <description>&lt;h2&gt;前言&lt;/h2&gt;

&lt;p&gt;读研时方向选定云计算虚拟化，之前一直在摸索学习各种IaaS软件，因老板项目需要找一款合适的开源软件做私有云，无奈实力所限OpenStack这样重量级的实在玩不动。在CloudStack群里有大牛推荐用ZStack简单好用，遂依照 http://ZStack.org/cn/installation/上的一键安装来安装 ZStack, 我这样的小白用all in one和扁平网络的方式，一个小时居然能跑起了VM，兴奋不已。&lt;/p&gt;

&lt;p&gt;后来老板要做VDI，了解相关信息之后发现可用的开源协议只有SPICE了，于是很自然的将Zstack和SPCIE结合起来。有朋友可能会问zs自身的conslo就有VNC啊，也可以接虚拟机图像。但是VNC主要用于linux的服务器的管理，由于无声音和usb传输，不满足于虚拟桌面的使用。而SPICE几乎全面超过VNC，尤其在图像质量和重定向这两部分，几乎是开源的不二选择。&lt;/p&gt;

&lt;h1&gt;实践操作&lt;/h1&gt;

&lt;p&gt;桌面虚拟化与服务器虚拟化的本质区别就是在协议优化，当然这里只讲怎么连上去。Zstack本身拥有VNC协议的Console，SPICE-client连接到VM的方式与VNC相同——都是通过套接字识别VM。在询问群主意见后，决定加一个开关ConsoleMode让其能在SPICE和VNC间自由切换。那么问题来了，具体怎么做呢？&lt;/p&gt;

&lt;p&gt;正好看到ZStack开发分享http://zstack.org/cn_blog/add-qemu-mode-to-zstack.html，作为一只小白，照葫芦画瓢的事情当然最好不过了。思路立马清晰了：1. 新增一个全局的变量叫 ConsoleMode（Java编写） 2. 将此新的全局变量传给 ZStack-utility 里的 agent (Python 编写的) 3. 在 Python编写的 agent 里, 依照此全局变量的值做出对应的设置（哈哈，写到这里我自己都笑了）。&lt;/p&gt;

&lt;h2&gt;步骤一&lt;/h2&gt;

&lt;p&gt;首先修改 ZStack 的部分, 在 conf/globalConfig/kvm.xml新增一个element
&lt;img src=&quot;/images/blogs/spice/1.jpg&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;config&amp;gt;
     &amp;lt;category&amp;gt;kvm&amp;lt;/category&amp;gt;
     &amp;lt;name&amp;gt;consoleMode&amp;lt;/name&amp;gt;
   &amp;lt;description&amp;gt;You can choose a transport protocol for consolemode,when set to spice, enable the spice protocol connection virtual machine.options:[vnc,spice]&amp;lt;/description&amp;gt;
     &amp;lt;type&amp;gt;java.lang.String&amp;lt;/type&amp;gt;
     &amp;lt;defaultValue&amp;gt;vnc&amp;lt;/defaultValue&amp;gt;
&amp;lt;/config&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;在 plugin/kvm/src/main/java/org/zstack/kvm/KVMGlobalConfig.java 新增全局的变量
&lt;img src=&quot;/images/blogs/spice/2.jpg&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@GlobalConfigValidation(validValues = {&quot;vnc&quot;,&quot;spice&quot;})
public static GlobalConfig VM_CONSOLE_MODE = new GlobalConfi(CATEGORY, &quot;consoleMode&quot;);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt; 到此基本上已经在 Web UI 的 Global Configure 新增一个配置 ConsoleMode (见下图)，等到我们修改完成后，将该值从vnc修改为spice即可（默认为vnc）。注意：如果已经running的VM需要重启，才会生效。
&lt;img src=&quot;/images/blogs/spice/3.jpg&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h2&gt;步骤二&lt;/h2&gt;

&lt;p&gt;修改 ZStack 的部分, 在plugin/kvm/src/main/java/org/zstack/kvm/KVMAgentCommands.java 中 public static class StartVmCmd 中新增私有的变量及公有的方法
&lt;img src=&quot;/images/blogs/spice/4.jpg&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;private String consoleMode;

public String getConsoleMode() {
         return consoleMode;
     }
     public void setConsoleMode(String consoleMode) {
         this.consoleMode = consoleMode;
     }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;接著修改 plugin/kvm/src/main/java/org/zstack/kvm/KVMHost.java 在 startVm 方法里透过 VolumeTO 类新增的方法将新增的 Global Config 配置传给 zstack-utility agent
&lt;img src=&quot;/images/blogs/spice/6.jpg&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h2&gt;步骤三&lt;/h2&gt;

&lt;p&gt;最后我们还要修改 zstack-utility agent在收到我们新增的全局配置后做出对应的修改 kvmagent/kvmagent/plugins/vm_plugin.py
&lt;img src=&quot;/images/blogs/spice/5.jpg&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def get_console_port(self)
if (g.type_ ==&#39;vnc&#39;)or(g.type_==&#39;spice&#39;):

def make_console():
if cmd.consoleMode == &#39;spice&#39;:
            make_spice()
        else:
            make_vnc()

def make_spice():
        devices = elements[&#39;devices&#39;]
        spice = e(devices, &#39;graphics&#39;, None, {&#39;type&#39;:&#39;spice&#39;, &#39;port&#39;:&#39;5900&#39;, &#39;autoport&#39;:&#39;yes&#39;})
        e(spice, &quot;listen&quot;, None, {&#39;type&#39;:&#39;address&#39;, &#39;address&#39;:&#39;0.0.0.0&#39;})
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;步骤四&lt;/h2&gt;

&lt;p&gt;依照官方说明的方法来编译ZStack All In One 安装包http://zstack.org/cn_blog/build-zstack.html&lt;/p&gt;

&lt;h1&gt;总结&lt;/h1&gt;

&lt;p&gt;限于本人能力所限，只是加了个切换协议开关，如果想在web上直接显示SPICE链接的远程桌面，还需要添加web-spice-client的代码。所以想体验的同学暂时还需要使用官方的virt-viewer软件才能连接哦，附效果图一张~最后严重感谢惯C哥的帮助^_^
&lt;img src=&quot;/images/blogs/spice/7.jpg&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;
</description>
        <pubDate>Sun, 10 Jan 2016 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/create_spice_for_console.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/create_spice_for_console.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
      <item>
        <title>给不同L3网络设置不同的 VirtualRouter Offering</title>
        <description>&lt;h2&gt;前言&lt;/h2&gt;

&lt;p&gt;当用户的网络环境中有多套公有L3网络并且使用了 VirtualRouter(VR) 的网络服务的时候，就需要给创建虚拟机的L3网络配置不同的VR Offering。&lt;/p&gt;

&lt;p&gt;由于每个VR Offering会设置特定的管理网络L3和公有网络L3，所以不同公有网络的L3网络应该配备不同的VR Offering，
否则会导致使用其中某个L3网络的虚拟机无法获得正常的网络连接能力。&lt;/p&gt;

&lt;h2&gt;网络场景描述&lt;/h2&gt;

&lt;p&gt;让我们先来看三种网络场景。第一张图描述了在一个典型的EIP网络模型下，有两个用户的私有网络，整个环境共用了相同的管理网络和公有网络。
在这个场景中，不同的用户网络进行了隔离。用户网络内的虚拟机通讯只发生在私有网络上。当需要访问外网环境时，
VM会通过不同的VR连接相同的公有网络。在这里，我们只需要设置一个默认的VR Offering即可，因为两个VR都是使用相同的公有网络。也就是说VR的配置相同。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/vroffering/zstack_1_pub_l3-2_pri_l3.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;有时候，由于一些特殊的原因（例如需要分摊流量、需要设置不同的公网出口等），我们会配置类似于第二张图的场景。
这个场景和第一张图唯一的不同是在于，两个私有网络访问公网的时候并不是通过相同的共有网络。
这个时候我们就需要给两个私有网络（private l3）配置不同的VR Offering。让其中一个VR走 Public L3-1 访问公网，
而另外一个走 Public L3-2 访问公网。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/vroffering/zstack_2_pub_l3_2_pri_l3.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;在扁平网络（Flat Network）模式中，我们更可能遇到多个公有网络的场景。每个公有网络有独立的网关。
例如下图所示，两个VR只负责给各自的L3网络做DHCP和DNS服务，
虚拟机VM1和VM3分别通过不同的公有网络进行网络通讯。这个时候我们也需要给两个公有网络（public l3）配置不同的 VR Offering。
VM会根据所在的不同的L3网络连接公有网络。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/vroffering/zstack_2_pub_l3.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h2&gt;给不同的L3网络设置不同的VR Offering&lt;/h2&gt;

&lt;p&gt;首先我们要根据公有网络的数量创建相同数量VR Offering，我们可以把最常用L3的VR Offering设置成默认的。&lt;/p&gt;

&lt;p&gt;接着我们就可以给不同L3网络配置不同VR Offering。具体的方法是通过设置系统标签（System Tag）的方式来完成的。
设置系统标签的zstack-cli命令是：&lt;/p&gt;

&lt;p&gt;&lt;code&gt;CreateSystemTag resourceType=InstanceOfferingVO resourceUuid=YOUR_VR_OFFERING_UUID tag=guestL3Network::YOUR_L3_NETWORK_UUID&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;这里的YOUR_VR_OFFERING_UUID需要替换成目标VR Offering的UUID
YOUR_L3_NETWORK_UUID替换为用于创建VM的L3网络的UUID。EIP模式下（图二），该网络是Private L3。
扁平模式下（图三），该网络是Public L3的UUID。千万留意该L3 网络UUID不可以指定错误。&lt;/p&gt;

&lt;p&gt;如果还不熟悉zstack-cli命令，可以参考ZStack的用户教程里各种&lt;a href=&quot;http://zstack.org/cn/tutorials/flat-network-cli.html&quot;&gt;命令行版本&lt;/a&gt;的操作方法。&lt;/p&gt;

&lt;p&gt;设置完后，ZStack就可以正确识别不同L3网络的VR Offering，并为不同VM使用不同的网络服务。&lt;/p&gt;

&lt;p&gt;更多关于网络服务和VR的信息可以参考：&lt;a href=&quot;http://zstackdoc.readthedocs.org/en/latest/userManual/virtualRouter.html&quot;&gt;ZStack API文档&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 31 Dec 2015 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/assign_vr_offering_for_different_l3.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/assign_vr_offering_for_different_l3.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
      <item>
        <title>ZStack开发分享－－给Qemu增加Cache Mode</title>
        <description>&lt;h2&gt;前言&lt;/h2&gt;

&lt;p&gt;笔者一直以来都持续关心着各种云相关的软件发展的情形和趋势, 但始终没有真正的去折腾它。
直到今年五月份在 Ceph 群组里听到了一个名为 ZStack的 IaaS 开源软件, 于是在自己的好奇心驱使下加入了 ZStack中国社区QQ群组。
在群里潜水了几个月后发现安装似乎很容易, 所以开始试著依照
http://ZStack.org/cn/installation/ 上的一键安装来安装 ZStack, 果然是非常容易安装&lt;/p&gt;

&lt;p&gt;接着按照&lt;a href=&quot;http://ZStack.org/cn/tutorials/flat-network-ui.html&quot;&gt;扁平网络的教程&lt;/a&gt;, 正准备继续折腾，却发生VM 无法启动的问题, 顿时觉得有点小失望。&lt;/p&gt;

&lt;p&gt;详细的错误讯息请见
https://github.com/ZStackorg/ZStack/issues/146&lt;/p&gt;

&lt;p&gt;后来通过Google搜索发现原来是 Qemu 的 Cache Option 和文件系统兼容性所引起的问题。
这个问题的起源是因为我的机器里用的文件系统是ZFS (操作系统是 Ubuntu 14.04), 但是ZFS 不支持 O_DIRECT 所造成的。
因为 ZStack 0.9中在创建 VM 时都是使用 &#39;cache=none&#39;, 但是在 ZFS 作为 VM 主存储时 cache 必须为 writethrough 或者 writeback 才行。
去群里向原开发者请教之后发现可以通过在 GlobalConfig中增加一个配置来实现Qemu cache 模式的切换，来解决这个问题。
看起来这个方法实现起来也不会太困难, 于是开始着手解决这个问题。&lt;/p&gt;

&lt;h2&gt;实际动手&lt;/h2&gt;

&lt;p&gt;先参考一些官方的文件来了解 ZStack 源代码
(以下些许内容取自 ZStack 官网 http://ZStack.org/cn )
目前ZStack的源代码由三个软件仓库构成：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;ZStack使用Java编写，是ZStack的核心，负责IaaS各种资源管理调度和消息通讯；&lt;/li&gt;
&lt;li&gt;ZStack-utility目前主要使用Python编写，包含ZStack的各种终端代理和其他工具。 这些终端代理负责接收来自ZStack核心的消息并执行对应的操作，例如和Libvirt通讯来管理VM的生命周期、各种存储（例如Ceph，iSCSI，SFTP）的管理、 虚拟路由器里管理VM的IP地址等等。除了终端代理工具外，这个软件仓库还包含了ZStack其他的工具，例如ZStack的编辑打包工具、 ZStack安装程序、ZStack命令行工具、ZStack管控工具等等。&lt;/li&gt;
&lt;li&gt;ZStack-dashboard使用JavaScript编写，是ZStack的图形界面。&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;(为免篇幅太长, 关于怎么从 Github 取出源码的部分在此省略了)&lt;/p&gt;

&lt;p&gt;基本上修改的思路为三个步骤：
 1. 新增一个全局的变量叫 CacheMode （Java编写）
 2. 将此新的全局变量传给 ZStack-utility 里的 agent (Python 编写的)
 3. 在 Python编写的 agent 里, 依照此全局变量的值做出对应的设置&lt;/p&gt;

&lt;h3&gt;步骤一&lt;/h3&gt;

&lt;p&gt;首先修改 ZStack 的部分,
在 conf/globalConfig/kvm.xml新增一个element&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/1.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;在 plugin/kvm/src/main/java/org/ZStack/kvm/KVMGlobalConfig.java 新增全局的变量&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/2.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;到此基本上已经在 Web UI 的 Global Configure 新增一个配置 vm.CacheMode (见下图)&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/3.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h3&gt;步骤二&lt;/h3&gt;

&lt;p&gt;修改 ZStack 的部分,
在plugin/kvm/src/main/java/org/ZStack/kvm/KVMAgentCommands.java 中
public static class VolumeTO 中新增私有的变量及公有的方法&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/4.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;接著修改 plugin/kvm/src/main/java/org/ZStack/kvm/KVMHost.java
在 startVm 方法里透过 VolumeTO 类新增的方法将新增的 Global Config 配置传给 ZStack-utility agent&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/5.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;到这边 ZStack 部分算是修改完成&lt;/p&gt;

&lt;h3&gt;依照官方说明的方法来编译ZStack Java 源码&lt;/h3&gt;

&lt;p&gt;http://ZStack.org/cn_blog/build-ZStack.html&lt;/p&gt;

&lt;p&gt;&lt;code&gt;cd ZStack&lt;/code&gt;
&lt;code&gt;mvn -DskipTests clean install&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/6.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;如果过程顺利应该会看到如下的输出&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/7.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h3&gt;步骤三&lt;/h3&gt;

&lt;p&gt;最后我们还要修改 ZStack-utility agent在收到我们新增的全局配置后做出对应的修改
kvmagent/kvmagent/plugins/vm_plugin.py&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/8.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/9.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h3&gt;步骤四&lt;/h3&gt;

&lt;p&gt;依照官方说明的方法来编译ZStack All In One 安装包
http://ZStack.org/cn_blog/build-ZStack.html&lt;/p&gt;

&lt;h3&gt;编译ZStack All In One安装包&lt;/h3&gt;

&lt;p&gt;如果ZStack的Java源码已经编译通过，我们就可以开始尝试编译ZStack All In One安装包了：
&lt;code&gt;cd ~/ZStack-repos/&lt;/code&gt;
&lt;code&gt;wget -c http://archive.apache.org/dist/tomcat/tomcat-7/v7.0.35/bin/apache-tomcat-7.0.35.zip&lt;/code&gt;
&lt;code&gt;cd ZStack-utility/ZStackbuild&lt;/code&gt;
&lt;code&gt;ant -DZStack_build_root=/root/ZStack-repos all-in-one&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;因为default git 都会去 checkout master 分支来编译  ZStack All In One包,下面是我使用的方式&lt;/p&gt;

&lt;p&gt;&lt;code&gt;ant    -DZStack.build_version=0.9fix
-DZStackutility.build_version=0.9fix
-DZStackdashboard.build_version=0.9
-Dbuild_name=qa
-DZStack_build_root=/home/matt/ZStack-github all-in-one&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;(关于 –D 相关的选项, 可以看 ZStack-utility/ZStackbuild/build.properties)
如果过程顺利应该会看到如下的输出&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blogs/cache_mode/10.png&quot; class=&quot;center-img img-responsive&quot;&gt;&lt;/p&gt;

&lt;h3&gt;后话&lt;/h3&gt;

&lt;p&gt;对于新增全局配置的修改大致上就是这样, 唯一要特别注意的地方是, 修改 ZStack Java代码的部分, 关于新增全局配置的变量和方法该摆放在哪一个类, 为了以后代码的维护以及可读性, 最好还是可以跟原始开发者讨论讨论, 本范例会修改在 VolumeTO 类 里, 不代表著所有新增的全局配置都需要修改在那边（意思是有经过些许判断的）, 主要还是得依照新增的配置去找出比较相关的类去修改会比较适当, 以上为个人一点小小的心得。&lt;/p&gt;
</description>
        <pubDate>Tue, 22 Dec 2015 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/add-qemu-mode-to-zstack.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/add-qemu-mode-to-zstack.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
      <item>
        <title>ZStack 助力PaaS／SaaS 高效集成IaaS －－ ZStack云环境的快速备份和还原</title>
        <description>&lt;p&gt;ZStack的快速安装能力解决了传统基础架构即服务软件部署过程过于繁琐的问题。不过安装IaaS软件本身只是第一步。
安装ZStack之后，用户还需要在ZStack上添加计算、存储、网络等相关资源，才能创建云主机。如果用户需要反复的测试部署云环境的过程，例如：&lt;/p&gt;

&lt;p&gt;1，给不同的客户演示ZStack的环境的使用过程
2，PaaS和SaaS产品，需要集成ZStack作为IaaS管控层。在搭建PaaS／SaaS私有云的过程中，快速搭建ZStack云环境。&lt;/p&gt;

&lt;p&gt;ZStack已经充分的考虑了PaaS／SaaS用户的快速集成，以及需要经常的搭建演示相同的ZStack环境的需求。
对此，ZStack提供了备份和还原云的能力。用户只需要把当前搭建好的云环境备份到一个xml文件中，
之后就可以在一个新装的ZStack环境里使用该xml文件快速还原云环境。&#39;&#39;&#39;这一切都要归功于ZStack的全API交付能力&#39;&#39;&#39;。
所谓IaaS API的全交付能力，就是指通过API便可以创建IaaS所需要的全部资源。&lt;/p&gt;

&lt;p&gt;下面我们就来看一看ZStack的备份和还原云是怎么操作的。&lt;/p&gt;

&lt;p&gt;假设我们已经搭建了ZStack，并且配置了一个可以创建虚拟机的云环境。那么备份当前云环境的命令非常简单：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;首先你需要用zstack-cli登录zstack环境（如果没有更改过密码，密码就是password）：&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;zstack-cli LogInByAccount accountName=admin password=password&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;如果IaaS已经部署（或者部署了一部分，例如你可以只部署到下载完Image Template和添加完主存储和备份存储的相关操作。
那么下次还原的时候，也可以是恢复一个IaaS云环境的中间状态），就可以用下面的命令来备份云环境到一个xml文件中去，
备份的参数是 &#39;-D&#39; （切勿和还原的小 &#39;-d&#39; 搞混淆，每次执行命令前也可以使用&#39;-h&#39;查看）：&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;zstack-cli -D /tmp/ec2-cloud.xml&lt;/p&gt;

&lt;p&gt;dump好的xml文件的内容是这样的：&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;img-responsive&quot; src=&quot;/images/blogs/dump-zstack/dump-xml.png&quot;&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;需要注意的是zstack-cli在备份云环境的时候，调用的是Query相关的API。由于Query API无法取到两个重要信息的：
&#39;&#39;&#39;Host的用户名和密码，SftpBackupStorage的用户名和密码&#39;&#39;&#39;，所以这两个信息需要用户手动添加，不过手动编辑一下还是非常简单的：&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;img-responsive&quot; src=&quot;/images/blogs/dump-zstack/dump-xml2.png&quot;&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li&gt;还原IaaS环境前，为了保证一个干净的环境，请务必停止ZStack server，重新初始化数据库，和再重启ZStack server
(如果是全新安装的ZStack，可以跳过这步。)：&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;code&gt;zstack-ctl stop_node&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;zstack-ctl deploydb --host=YOUR_DB_IP_ADDRESS --drop&lt;/p&gt;

&lt;p&gt;&lt;code&gt;zstack-ctl start_node&lt;/code&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;使用下面这条命令来还原IaaS环境：&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;zstack-cli -d /tmp/ec2-cloud.xml&lt;/p&gt;

&lt;p&gt;如果用户的image是放在本地的，整个还原过程会非常快速（例如小于1分钟）。&lt;/p&gt;

&lt;p&gt;有了云环境的快速备份和还原，ZStack是不是非常适合我们的PaaS和SaaS软件集成呢？ZStack欢迎和各种PaaS和SaaS的应用服务公司合作。&lt;/p&gt;
</description>
        <pubDate>Wed, 11 Nov 2015 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/zstack-dump-and-redeploy-cloud.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/zstack-dump-and-redeploy-cloud.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
      <item>
        <title>更新计算节点和备份存储的密码</title>
        <description>&lt;p&gt;当用户更新了计算节点（Host）或者备份存储（Sftp Backup Storage）密码后，如果没有通知ZStack，
之后可能会遇到ZStack重连该资源失败的问题。
所以用户在更改资源的用户密码后需要通过ZStack的API来更新ZStack记录的这些资源的root用户密码。&lt;/p&gt;

&lt;h2&gt;更新资源root密码的操作如下：&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;登录zstack-cli&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;code&gt;zstack-cli LogInByAccount accountName=admin password=password&lt;/code&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;更新Host节点用户密码&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;code&gt;zstack-cli UpdateKVMHost uuid=YOUR_KVM_HOST_UUID password=YOUR_HOST_NEW_ROOT_PASSWORD&lt;/code&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;重连Host节点&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;code&gt;zstack-cli ReconnectHost uuid=YOUR_KVM_HOST_UUID&lt;/code&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;更新备份存储用户密码&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;code&gt;zstack-cli UpdateSftpBackupStorage uuid=YOUR_SFTP_BS_UUID password=YOUR_SFTP_BS_NEW_ROOT_PASSWORD&lt;/code&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;重连备份存储&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;code&gt;zstack-cli ReconnectSftpBackupStorage uuid=YOUR_SFTP_BS_UUID&lt;/code&gt;&lt;/p&gt;

&lt;h2&gt;一次性更改主机密码并更新ZStack&lt;/h2&gt;

&lt;p&gt;因为zstack-cli是一个可以在shell执行的命令行工具，所以用户可以用shell script做一个wrapper。
用户使用该wrapper就可以把更改主机root密码和更新ZStack数据库的操作在一个脚本里完成。例如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@localhost ~]# cat change_passwd_wrapper.sh
#Execute in management node. The target_host_ip is the host IP address recorded
# in ZStack. You need to install command jq to parse JSON.
which jq &amp;amp;&amp;gt;/dev/null|| (echo &quot;please install jq firstly&quot; &amp;amp;&amp;amp; exit 1)
target_host_ip=$1
new_passwd=$2
ssh $target_host_ip &quot;echo \&quot;root:$new_passwd\&quot; | chpasswd&quot;
zstack-cli LogInByAccount accountName=admin password=password
host_uuid=`zstack-cli QueryHost managementIp=$target_host_ip |jq &#39;.inventories[0].uuid&#39;`
zstack-cli UpdateKVMHost uuid=$host_uuid password=$new_passwd
zstack-cli ReconnectHost uuid=$host_uuid
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;该脚本的使用方法是：&lt;/p&gt;

&lt;p&gt;&lt;code&gt;[root@localhost ~]# ./change_passwd_wrapper.sh 10.0.101.2 new_passwd&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;该命令首先会ssh到目标的host（10.0.101.2）上用chpasswd命令来更改root的密码为new_passwd。
然后会调用ZStack的API把相应的信息更新到ZStack的数据库中，并且重连Host。
需要注意的是这里的IP地址需要和Host在ZStack中使用的managementIp为相同的字符串，否则更新ZStack会失败。
另外该脚本中使用了&lt;code&gt;jq&lt;/code&gt;来解析JSON字符串，所以用户需要预先安装jq。&lt;/p&gt;

&lt;p&gt;用户在实际使用ZStack环境中如果遇到问题，可以到ZStack官方QQ群：&lt;strong&gt;410185063&lt;/strong&gt; 寻求更多帮助。&lt;/p&gt;
</description>
        <pubDate>Mon, 12 Oct 2015 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/updte-host-and-sftp-backup-storage-password.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/updte-host-and-sftp-backup-storage-password.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
      <item>
        <title>ZStack Zhaitech Cooperation</title>
        <description>&lt;h1&gt;Cooperation with the machine learning startup -- Zhaitech&lt;/h1&gt;

&lt;p&gt;Today we are happy to announce that we have reached a cooperation agreement with Daqula Zhang, the CEO of the machine learning startup ZhaiTech. According the agreement, Zhaitech will choose ZStack as the unique cloud platform for their machine learning software, for both consumers and business customers; ZStack will provide the professional IaaS solution for Zhaitech, helping setup the on-premise cloud services.&lt;/p&gt;
</description>
        <pubDate>Sun, 11 Oct 2015 00:00:00 +0800</pubDate>
        <link>http://zstack.org/blog/zhaitech.html</link>
        <guid isPermaLink="true">http://zstack.org/blog/zhaitech.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>ZStack Zhaitech Cooperation</title>
        <description>&lt;h1&gt;Cooperation with the machine learning startup -- Zhaitech&lt;/h1&gt;

&lt;p&gt;Today we are happy to announce that we have reached a cooperation agreement with Daqula Zhang, the CEO of the machine learning startup ZhaiTech. According the agreement, Zhaitech will choose ZStack as the unique cloud platform for their machine learning software, for both consumers and business customers; ZStack will provide the professional IaaS solution for Zhaitech, helping setup the on-premise cloud services.&lt;/p&gt;
</description>
        <pubDate>Sun, 11 Oct 2015 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn/blog/zhaitech.html</link>
        <guid isPermaLink="true">http://zstack.org/cn/blog/zhaitech.html</guid>
        
        
        <category>blog</category>
        
      </item>
    
      <item>
        <title>扁平摸索 vs. EIP 模式 —— 在单机环境中搭建ZStack</title>
        <description>&lt;p&gt;ZStack作为标准IaaS软件管理计算、存储和网络三大子系统，其中网络子系统是最复杂的。用户在一个简单的单机环境中搭建IaaS，
最常遇到的问题就是该搭建哪种IaaS网络模型和在搭建该模型之前该如何在单机上准备必要的网络环境。
由于不当的网络环境准备，常会导致云主机的启动失败，或者启动后无法获得正确的IP地址。
今天我们将会介绍如何正确的准备用于搭建IaaS系统的网络环境。&lt;/p&gt;

&lt;p&gt;首先，让我们来简单介绍一下两种不同的IaaS网络方案：&lt;a href=&quot;http://zstack.org/cn/tutorials/flat-network-ui.html&quot;&gt;扁平网络&lt;/a&gt;和
&lt;a href=&quot;http://zstack.org/cn/tutorials/ec2-ui.html&quot;&gt;EIP网络&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;1. 扁平网络&lt;/h2&gt;

&lt;p&gt;&lt;img  class=&quot;img-responsive&quot;  src=&quot;/images/flat_network.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;扁平网络是私有云环境中最常用、最简单的网络环境。用户的云主机和计算节点处于相同的网络层，&lt;/p&gt;

&lt;p&gt;用户的应用完全不会感知自己运行在云主机中、还是物理主机中。用户的应用会非常容易的从物理机迁移到扁平网络的云主机中。
在扁平网络中，假设用户设置的Public-L2的网卡设备为eth0，那么ZStack创建的云主机的IP地址将会和eth0所在的网络拥有相同的网段。
例如用户计算节点eth0的IP地址为192.168.0.2（网关为192.168.0.1，子网掩码为255.255.255.0），用户在Public-L3中设置的IP Range为
192.168.0.100～192.168.0.200。那么在创建在Public-L3网络上的云主机将会自动从ZStack获取192.168.0.100～192.168.0.200中的一个IP地址。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：用户在设置Public-L3的IP Range的时候需要避免和eth0网络上其他网络设备的IP地址冲突&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：用户在设置Public-L3的网关和子网掩码错误，将会导致创建的云主机无法访问网关以外的网络，例如Internet。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：用户在添加Public-L3的网络服务时，如果没有选择DHCP的服务，可能会导致新创建的云主机无法获得IP地址，
或者获得IP地址和ZStack分配的不一致。这是因为该云主机并不知道ZStack给它分配的IP地址为多少。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：如果eth0网络上有其他DHCP服务器，Public-L3也选择了DHCP服务，有可能会导致云主机获取的IP地址不是ZStack分配的。
这是因为云主机拿到了从网络上原有DHCP服务器分配的IP地址。用户可以通过设置原有DHCP服务器，来禁止它给新的云主机分配IP地址。
不过用户不必担心ZStack的DHCP服务会污染网络上的其他DHCP服务，因为ZStack的DHCP服务器只会给指定MAC的云主机分配IP地址。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;在阅读以上注意事项后，希望用户在打算实施私有云部署前，需要预先考虑如何优化公司网络配置。
原则上也很简单，就是用户可以准备一个全新的二层网络环境。给该二层网络环境配置一个网关和对应的IP CIDR，并且不配置任何的DHCP服务。&lt;/p&gt;

&lt;p&gt;扁平网络也可以直接用于“公有云”业务，也就是每一个云主机都有一个互联网的独立IP地址。很多VPS提供商利用该模式提供服务。
需要注意的是，扁平网络的云主机之间没有二层网络隔离，网络安全需要通过三层的安全组（Security Group）提供。
用户在选择Public-L3网络服务的时候，需要选上Security Group。通常情况下，三层网络安全控制已经可以达到要求。&lt;/p&gt;

&lt;h2&gt;2. EIP 网络&lt;/h2&gt;

&lt;p&gt;&lt;img  class=&quot;img-responsive&quot;  src=&quot;/images/eip.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;EIP的网络模式（Port Forwarding的模式与EIP模式几乎类似）实际是经典的亚马逊AWS EC2模式。在该模式中，云主机会被设置上两个IP地址。
其中一个是私网IP地址，也就是在云主机中用ifconfig看到的IP地址。还有一个是公网IP地址（可以是互联网的IP地址，也可以是公司内部网络的IP地址）。
云主机的私网IP地址无法从外部直接连接（例如，无法从Internet上连接某公司内部一个IP为192.168.0.10的机器）。
用户通过公网IP地址可以登录该云主机，并进行相关的操作。由于该模式是经典的公有云模式，所以其他公有云也大多提供类似的模式。&lt;/p&gt;

&lt;p&gt;在ZStack的EIP网络中，云主机的私网和公网之间是通过路由器（例如虚拟路由器）来隔离和中转的。虚拟路由器既承担了DHCP、DNS这样的服务，
也承担了网关和DNAT的服务。这种做法可以做到更有效的网络隔离，也可以在公网IP地址有限的情况下节省公网IP地址。
如果云主机提供的网络服务只供私网内的其他云主机使用，就不需要获得一个独立的公网IP地址。
在公有云业务中，每个独立的公网IP地址也都是需要收费的。&lt;/p&gt;

&lt;p&gt;在EIP模式中，虚拟路由器至少需要拥有一个公网IP地址，用于私网内部云主机访问公网的中转。在没有给云主机配置EIP之前，
公网上的其他网络设备是无法透过虚拟路由器访问云主机的，但是云主机依然可以通过虚拟路由器访问公网（SNAT）。
而EIP相当于DNAT，相当于在虚拟路由器上假设了一个桥梁。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：在很多网络环境中，用户采用了EIP的网络架构，但是未必需要使用EIP功能。用户可能只用虚拟路由器的SNAT来分割内外网。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;私有云是否会使用EIP网络模式呢？答案是根据用户的需求和网络环境来确定的。通常有两种私有云的情况会使用EIP模式：&lt;/p&gt;

&lt;p&gt;一，提供网络服务的公司有一些不多的互联网IP地址。提供网络服务的云主机搭建在公司内网环境，用于连接数据库服务器和应用服务器。
通过EIP，可以让用户可以直接访问放置在公司内网的云主机。如果云主机需要迁移、升级、扩容，用户也可以把EIP在不同的云主机之间进行无缝迁移。
当需要使用负载均衡的时候，该EIP服务可以变身为负载均衡器，把来源于用户的网络访问分散到不同的云主机上。&lt;/p&gt;

&lt;p&gt;二，公司的部门较多，有部门需要在公司内网环境里划分独立的私有网络，该私有网络可以访问公司内网，但是公司其他部门不能直接连接私有网络的机器。
这个场景中，云主机EIP的IP地址是公司内网IP地址。使用EIP网络拓扑可以给每个部门的私有网络分配不同的Vlan号以达到二层网络隔离。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：用户在设置Public-L3的IP Range的时候需要避免和eth0网络上其他网络设备的IP地址冲突。否则如果虚拟路由器可能会启动失败，
并报告IP地址被占用。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意：在EIP模式中，如果Public-L2（如eth0）上有其他DHCP服务器，并不会影响虚拟路由器的IP地址分配。
这是因为虚拟路由器的IP地址是ZStack从Public-L3的IP Range中静态指定的。用户唯一需要注意的是，
需要预先在原有网络上DHCP服务器预留一段静态IP地址用于虚拟路由器的IP地址和EIP的IP地址。预留出来的IP地址，
也就是用户设置在Public-L3上面的IP Range。&lt;/strong&gt;&lt;/p&gt;

&lt;h2&gt;3. 单机配置扁平网络和EIP网络&lt;/h2&gt;

&lt;p&gt;实战过程中，很多用户会常会在单机上尝试练习扁平网络和EIP网络模式。如果用户能够简单的配置原有网络环境，
那么可以轻松的测试。但是通常情况下，用户的单机网络环境可能和我们之前定义的网络环境有些差异。
例如，我们要求原有网络中预留一些和eth0网络的IP地址给Public-L3，但是由于一些原因无法更改原有网络的网络分配。
又例如，用户的测试机器直接连在Internet上，eth0只有一个Internet的IP地址，没有更多的公网IP地址。
这个时候，我们需要一些特别的手段来营造合适的网络环境。这个手段，就是在单机上创建一个独立的网络设备eth0.10。
我们给该网络设备配置上一个172.16.0.1的IP地址，并将该设备用于Public-L2，这样就可以创建一个干净的网络环境用于ZStack测试。
如果单机的网卡设备不是eth0，也可以做个替换，例如把eth0换成em1。&lt;/p&gt;

&lt;p&gt;具体的配置为：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Public-L2：eth0.10&lt;/li&gt;
&lt;li&gt;Public L3 IP Range: 172.16.0.2~172.16.0.254&lt;/li&gt;
&lt;li&gt;Public L3 Netmask: 255.255.255.0&lt;/li&gt;
&lt;li&gt;Public L3 Gateway: 172.16.0.1&lt;/li&gt;
&lt;li&gt;Private-L2(EIP模式）：eth0，vlan 100&lt;/li&gt;
&lt;li&gt;Private L3 CIDR: 10.0.0.1/24&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;eth0.10的创建方法：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;vconfig add eth0 10&lt;/li&gt;
&lt;li&gt;ifconfig eth0.10 172.16.0.1 netmask 255.255.255.0&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;为何要给eth0.10设置172.16.0.1的IP地址？有两个原因：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;虚拟路由器会从Public L3上获得一个172.16.0.x的IP地址，ZStack需要连接它&lt;/li&gt;
&lt;li&gt;需要把172.16.0.1作为网关，连接eth0，让云主机可以连通公网。&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;打通eth0.10到eth0的网络：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE&lt;/li&gt;
&lt;li&gt;iptables -A FORWARD -i eth0.10 -j ACCEPT&lt;/li&gt;
&lt;li&gt;iptables -A FORWARD -i br_eth0.10 -j ACCEPT&lt;/li&gt;
&lt;/ol&gt;


&lt;h3&gt;3.1 练习扁平网络&lt;/h3&gt;

&lt;p&gt;&lt;img  class=&quot;img-responsive&quot;  src=&quot;/images/blogs/misc/single-machine-flat-network.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;如上图所示，扁平网络模式下的云主机和虚拟路由器都将会获得172.16.0.x的IP地址。&lt;/p&gt;

&lt;h3&gt;3.2 练习EIP网络&lt;/h3&gt;

&lt;p&gt;&lt;img  class=&quot;img-responsive&quot;  src=&quot;/images/blogs/misc/single-machine-eip-network.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;如上图所示，虚拟路由器都将会跨接br_eth0.10和br_eth0.100两个网络。在br_eth0.10网络上，会获得172.16.0.x的IP地址；
在br_eth0.100网络上会获得10.0.0.1的IP地址。其他云主机将会获得10.0.0.x的IP地址。给云主机申请的EIP地址将会是172.16.0.x。
这个时候用户可以直接通过在计算节点上ssh EIP地址，但是无法直接ssh 云主机的私网地址。&lt;/p&gt;

&lt;p&gt;用户在实际使用ZStack环境中如果遇到问题，可以到ZStack官方QQ群：&lt;strong&gt;410185063&lt;/strong&gt; 寻求帮助。&lt;/p&gt;

&lt;h2&gt;参考文献：&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;./virtualrouter-introduction.html&quot;&gt;ZStack 虚拟路由器工作流程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/cn/tutorials/flat-network-ui.html&quot;&gt;扁平网络教程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/cn/tutorials/ec2-ui.html&quot;&gt;EIP网络教程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://zstackdoc.readthedocs.org/en/latest/userManual/virtualRouter.html?highlight=virtual%20router&quot;&gt;虚拟路由器&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

</description>
        <pubDate>Sun, 04 Oct 2015 00:00:00 +0800</pubDate>
        <link>http://zstack.org/cn_blog/build-zstack-network-on-single-machine.html</link>
        <guid isPermaLink="true">http://zstack.org/cn_blog/build-zstack-network-on-single-machine.html</guid>
        
        
        <category>cn_blog</category>
        
      </item>
    
  </channel>
</rss>
